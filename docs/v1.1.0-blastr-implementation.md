# Haven v1.1.0 - Blastr リレー機能実装レポート

## 📅 実装日: 2025-12-25

## 🎯 実装目標
Haven に投稿したイベントを外部 Nostr リレーに自動転送する Blastr 機能を、Start9 UI から設定可能にする。

## ❌ 問題の分析

### 発見された症状
Haven に投稿すると以下のログが表示される：
```
2025-12-25T04:25:26+09:00  2025/12/24 19:25:26 🔫 blasted ... to 0 relays
```

### 根本原因
1. **Blastr 機能自体は実装済み**
   - `haven/blastr.go`: `blast()` 関数が存在
   - `haven/init.go`: イベント投稿時に `go blast(event)` を呼び出し
   - `haven/config.go`: `BlastrRelays` 設定フィールドが存在

2. **設定する方法がなかった**
   - `docker_entrypoint.sh`: `relays_blastr.json` を常に空配列 `[]` として初期化
   - `manifest.yaml`: Blastr リレーリストの設定項目なし
   - `getConfig.ts`/`setConfig.ts`: UI に設定項目なし

## ✅ 実装内容

### 1. 設定項目の追加 (`getConfig.ts`)

```typescript
"blastr-relays": {
  "type": "string",
  "name": "Blastr Relay List",
  "description": "Comma-separated list of relay URLs to broadcast events to. Events posted to Haven will be automatically forwarded to these relays.",
  "nullable": true,
  "placeholder": "wss://relay.damus.io,wss://nos.lol,wss://relay.nostr.band",
  "default": "relay.damus.io,nos.lol,relay.nostr.band,relay.snort.social,nostr.land,nostr.mom,relay.nos.social,relay.primal.net",
}
```

**特徴**:
- カンマ区切りで複数のリレーURLを指定
- ドメインのみ（`relay.damus.io`）でも、完全なURL（`wss://relay.damus.io`）でも指定可能
- デフォルトで8つの人気リレーを設定

### 2. バリデーション機能の追加 (`setConfig.ts`)

```typescript
// Validate blastr-relays if provided
if (newConfig['blastr-relays']) {
  const blastrRelays = newConfig['blastr-relays'];
  
  if (blastrRelays && blastrRelays.trim().length > 0) {
    const relays = blastrRelays.split(',').map(r => r.trim()).filter(r => r.length > 0);
    
    for (const relay of relays) {
      const hasProtocol = relay.startsWith('wss://') || relay.startsWith('ws://');
      const domainPart = hasProtocol ? relay.split('://')[1] : relay;
      
      const domainPattern = /^[a-zA-Z0-9][a-zA-Z0-9-_.]*\.[a-zA-Z]{2,}$/;
      
      if (!domainPattern.test(domainPart)) {
        throw new Error(`Invalid relay URL: "${relay}". Each relay must be a valid domain...`);
      }
    }
  }
}
```

**機能**:
- 各リレーURLの形式を検証
- ドメイン形式のバリデーション
- エラーメッセージで具体的な修正方法を提示

### 3. 設定の読み込みと反映 (`docker_entrypoint.sh`)

```bash
initialize_relay_lists() {
    # ... (既存のコード)
    
    # Blastr relay list from config
    local blastr_relays=$(yq e '.["blastr-relays"] // ""' /data/start9/config.yaml 2>/dev/null)
    
    if [ -n "$blastr_relays" ] && [ "$blastr_relays" != "null" ]; then
        log_info "Creating blastr relay list from config..."
        
        # Convert comma-separated string to JSON array
        echo "$blastr_relays" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' | jq -R -s -c 'split("\n") | map(select(length > 0))' > /app/relays_blastr.json
        
        local relay_count=$(jq '. | length' /app/relays_blastr.json)
        log_info "Blastr relays configured: $relay_count relay(s)"
    else
        log_info "No blastr relays configured, using empty list..."
        su-exec haven sh -c 'echo "[]" > /app/relays_blastr.json'
    fi
}
```

**処理フロー**:
1. Start9 config から `blastr-relays` を取得
2. カンマ区切り文字列を JSON 配列に変換
3. `/app/relays_blastr.json` に書き込み
4. ログにリレー数を表示

### 4. バージョン更新とリリースノート (`manifest.yaml`)

- バージョン: `1.0.8` → `1.1.0`
- 詳細なリリースノートを追加
- Blastr 機能の説明を記載

## 🧪 テスト手順

### ステップ 1: パッケージのインストール

```bash
# Start9 UI → System → Sideload Service
# または
start-cli package install haven.s9pk
```

### ステップ 2: Blastr リレーの設定

1. Haven の設定画面を開く
2. "Blastr Relay List" 項目を探す
3. リレーURLを入力（カンマ区切り）
   - 例: `relay.damus.io,nos.lol,relay.nostr.band`
4. 設定を保存
5. Haven を再起動

### ステップ 3: 動作確認

1. **ログの確認**
   ```bash
   # Start9 ログを確認
   # 以下のようなログが表示されるはず:
   # "Blastr relays configured: 8 relay(s)"
   ```

2. **イベント投稿**
   - Haven に Nostr イベントを投稿
   - ログで転送数を確認:
     ```
     🔫 blasted [event_id] to 8 relays
     ```

3. **外部リレーでの確認**
   - Nostr クライアント（Amethyst, Damus など）で外部リレーに接続
   - Haven に投稿したイベントが表示されることを確認

### ステップ 4: エラーケースのテスト

1. **無効なURLの入力**
   - 不正な形式を入力して保存
   - エラーメッセージが表示されることを確認

2. **空の設定**
   - Blastr リレーリストを空にして保存
   - `blasted ... to 0 relays` となることを確認

## 📊 期待される動作

### 成功時のログ
```
[INFO] Creating blastr relay list from config...
[INFO] Blastr relays configured: 8 relay(s)
...
🔫 blasted ea526ce6ebc7b278df59f132202d04cf2deb0304634036fdfc9ec14db3f63eed to 8 relays
```

### 設定なし時のログ
```
[INFO] No blastr relays configured, using empty list...
...
🔫 blasted ea526ce6ebc7b278df59f132202d04cf2deb0304634036fdfc9ec14db3f63eed to 0 relays
```

## 📁 変更されたファイル

1. `scripts/procedures/getConfig.ts` - 設定項目追加
2. `scripts/procedures/setConfig.ts` - バリデーション追加
3. `docker_entrypoint.sh` - 設定読み込みロジック追加
4. `manifest.yaml` - バージョン更新、リリースノート追加
5. `docs/bug_checklist.md` - 実装計画と進捗を記録

## 🎓 技術的な学び

### Haven のアーキテクチャ
- `config.go`: 環境変数からファイルベースの設定を読み込む
- `getRelayListFromFile()`: JSON ファイルからリレーリストを読み込み、`wss://` プレフィックスを自動追加
- `blast()`: goroutine で非同期にリレーへイベントを送信

### Start9 の設定管理
- `manifest.yaml`: 設定スキーマは直接記載せず、スクリプトで管理
- `getConfig.ts`: TypeScript で設定スキーマを定義（Start9 SDK の compat ヘルパーを使用）
- `setConfig.ts`: バリデーションロジックを実装
- `docker_entrypoint.sh`: config.yaml から環境変数に変換

## 🚀 今後の改善案

### v1.2.0 候補機能
1. **Blastr 転送ステータスの可視化**
   - Properties に転送成功数/失敗数を表示
   - 最後に転送したイベントのIDとタイムスタンプ

2. **リレー別の転送ログ**
   - どのリレーへの転送が成功/失敗したかを詳細に記録
   - タイムアウト時間の設定

3. **UI の改善**
   - リレーURLを1行1つで入力できるテキストエリア形式
   - リレーの接続テスト機能

4. **デフォルトリレーリストの更新**
   - 定期的に人気リレーのリストを更新
   - 地域別のリレー推奨

## ✅ チェックリスト

- [x] 要件分析
- [x] 実装計画策定
- [x] コード実装
  - [x] getConfig.ts
  - [x] setConfig.ts
  - [x] docker_entrypoint.sh
  - [x] manifest.yaml
- [x] ビルド成功
- [x] パッケージ検証完了
- [x] ドキュメント更新
- [ ] デプロイ（ユーザー実施）
- [ ] 実機テスト（ユーザー実施）

## 📝 備考

- Blastr 機能のコードは元々 Haven に実装されていたため、Haven 側の変更は不要
- Start9 の設定フローに合わせた実装のみで完結
- Haven の `config.go` の `getRelayListFromFile()` が自動的に `wss://` プレフィックスを追加するため、ドメインのみの指定でも動作する

---

**実装者**: AI Assistant  
**実装日**: 2025-12-25  
**バージョン**: 1.1.0  
**ステータス**: ✅ 実装完了、テスト待ち

