# Haven æ©Ÿèƒ½ä»•æ§˜ & å®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025-12-27  
**æœ€çµ‚æ›´æ–°**: 2025-12-27  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ€æ–°

---

## ğŸ“š ç›®æ¬¡

1. [Haven æ¦‚è¦](#-haven-æ¦‚è¦)
2. [ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#-ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [4ã¤ã®ãƒªãƒ¬ãƒ¼æ©Ÿèƒ½](#-4ã¤ã®ãƒªãƒ¬ãƒ¼æ©Ÿèƒ½)
4. [Blossom ãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ãƒãƒ¼](#-blossom-ãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ãƒãƒ¼)
5. [Web of Trust (WoT)](#-web-of-trust-wot)
6. [Import æ©Ÿèƒ½](#-import-æ©Ÿèƒ½)
7. [Blastr æ©Ÿèƒ½](#-blastr-æ©Ÿèƒ½)
8. [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½](#-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½)
9. [Rate Limiting](#-rate-limiting)
10. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹](#-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)
11. [è¨­å®šé …ç›®](#-è¨­å®šé …ç›®)
12. [Start9 çµ±åˆçŠ¶æ³](#-start9-çµ±åˆçŠ¶æ³)
13. [ä»Šå¾Œã®å®Ÿè£…è¨ˆç”»](#-ä»Šå¾Œã®å®Ÿè£…è¨ˆç”»)

---

## ğŸ¯ Haven æ¦‚è¦

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
**HAVEN** - High Availability Vault for Events on Nostr

### ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
æœ€ã‚‚ä¸»æ¨©çš„ãªãƒ‘ãƒ¼ã‚½ãƒŠãƒ« Nostr ãƒªãƒ¬ãƒ¼ã€‚eCashã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆã€ãƒ‰ãƒ©ãƒ•ãƒˆãªã©ã®ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒˆã‚’ä¿å­˜ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ã€Œè³¢ã„ãƒªãƒ¬ãƒ¼ã€ã€‚

### ä¸»è¦ç‰¹å¾´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HAVEN                           â”‚
â”‚  High Availability Vault for Events on Nostr       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  ğŸ”’ 4 Specialized Relays                           â”‚
â”‚  ğŸŒ¸ Blossom Media Server                           â”‚
â”‚  ğŸ•¸ï¸ Web of Trust Integration                       â”‚
â”‚  ğŸ“¦ Import & Sync                                   â”‚
â”‚  ğŸ”« Blastr Broadcasting                             â”‚
â”‚  â˜ï¸ Cloud Backups                                   â”‚
â”‚  ğŸ§… Tor-Only (Start9)                               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Client Applications                    â”‚
â”‚  (Amethyst, Damus, Primal, Coracle, nostrudel, etc.)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ WebSocket (wss://)
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Haven Main Process (Go)                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dynamic Relay Handler (main.go)              â”‚    â”‚
â”‚  â”‚  - Route requests to appropriate relay         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Private     â”‚ Chat        â”‚ Inbox    â”‚ Outbox   â”‚  â”‚
â”‚  â”‚ /private    â”‚ /chat       â”‚ /inbox   â”‚ /        â”‚  â”‚
â”‚  â”‚ (Auth)      â”‚ (Auth+WoT)  â”‚ (WoT)    â”‚ (Owner)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Blossom Media Server (blossom.go)              â”‚  â”‚
â”‚  â”‚  - NIP-96 & BUD-02 compliant                    â”‚  â”‚
â”‚  â”‚  - File storage: /data/blossom/                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Database Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Private  â”‚ Chat     â”‚ Inbox    â”‚ Outbox   â”‚Blossom â”‚â”‚
â”‚  â”‚ DB       â”‚ DB       â”‚ DB       â”‚ DB       â”‚ DB     â”‚â”‚
â”‚  â”‚ (LMDB/   â”‚ (LMDB/   â”‚ (LMDB/   â”‚ (LMDB/   â”‚(LMDB/  â”‚â”‚
â”‚  â”‚  Badger) â”‚  Badger) â”‚  Badger) â”‚  Badger) â”‚Badger) â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                          â”‚
â”‚  Storage: /data/db/{private,chat,inbox,outbox,blossom}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| è¦ç´  | æŠ€è¡“ |
|------|------|
| **è¨€èª** | Go 1.21+ |
| **ãƒªãƒ¬ãƒ¼å®Ÿè£…** | [khatru](https://github.com/fiatjaf/khatru) |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | LMDB (default) / BadgerDB |
| **Nostr ãƒ©ã‚¤ãƒ–ãƒ©ãƒª** | [go-nostr](https://github.com/nbd-wtf/go-nostr) |
| **Blossom** | [khatru/blossom](https://github.com/fiatjaf/khatru/tree/master/blossom) |
| **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—** | S3-compatible APIs |
| **ã‚³ãƒ³ãƒ†ãƒŠ** | Docker |
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | Tor (Start9) |

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ§‹é€  (Start9)

```
/data/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ private/           # Private relay database
â”‚   â”œâ”€â”€ chat/              # Chat relay database
â”‚   â”œâ”€â”€ inbox/             # Inbox relay database
â”‚   â”œâ”€â”€ outbox/            # Outbox relay database
â”‚   â””â”€â”€ blossom/           # Blossom metadata database
â”œâ”€â”€ blossom/               # Blossom media files (by SHA256)
â”‚   â”œâ”€â”€ <sha256_hash_1>
â”‚   â”œâ”€â”€ <sha256_hash_2>
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tor/
â”‚   â””â”€â”€ haven/             # Tor hidden service keys (persisted)
â”‚       â”œâ”€â”€ hostname
â”‚       â”œâ”€â”€ hs_ed25519_public_key
â”‚       â””â”€â”€ hs_ed25519_secret_key
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ haven.log          # Main application log
â”‚   â””â”€â”€ import-*.log       # Import session logs
â”œâ”€â”€ config/
â”‚   â””â”€â”€ .env               # Configuration file
â””â”€â”€ .import-request        # Import flag (when import pending)
```

---

## ğŸ” 4ã¤ã®ãƒªãƒ¬ãƒ¼æ©Ÿèƒ½

Haven ã¯ 4ã¤ã®å°‚é–€åŒ–ã•ã‚ŒãŸãƒªãƒ¬ãƒ¼ã‚’1ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ã§æä¾›ã—ã¾ã™ã€‚

### 1. Private Relay (`/private`)

**ç›®çš„**: ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å®Œå…¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªãƒªãƒ¬ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Private Relay (/private)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚¢ã‚¯ã‚»ã‚¹: Owner Only (NIP-42 Auth Required)        â”‚
â”‚ èª­ã¿å–ã‚Š: Owner Only                                â”‚
â”‚ æ›¸ãè¾¼ã¿: Owner Only                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨é€”:                                              â”‚
â”‚  - ãƒ‰ãƒ©ãƒ•ãƒˆ (Kind 31234: Draft Long-form)         â”‚
â”‚  - eCash ãƒˆãƒ¼ã‚¯ãƒ³ (Kind 7375, 7376)               â”‚
â”‚  - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ (Kind 10003)           â”‚
â”‚  - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªã‚¹ãƒˆ                               â”‚
â”‚  - ä»»æ„ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ¼ãƒˆ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:                                       â”‚
â”‚  âœ… NIP-42 (Auth) å¿…é ˆ                             â”‚
â”‚  âœ… Owner ä»¥å¤–ã¯èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿æ‹’å¦              â”‚
â”‚  âœ… Rate limiting                                  â”‚
â”‚  âœ… Empty/Complex filter åˆ¶é™å¯èƒ½                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:96-177`

**ä¸»è¦ã‚³ãƒ¼ãƒ‰**:
```go
privateRelay.RejectFilter = append(privateRelay.RejectFilter, 
  func(ctx context.Context, filter nostr.Filter) (bool, string) {
    authenticatedUser := khatru.GetAuthed(ctx)
    if authenticatedUser == nPubToPubkey(config.OwnerNpub) {
      return false, ""
    }
    return true, "auth-required: this query requires you to be authenticated"
})

privateRelay.RejectEvent = append(privateRelay.RejectEvent, 
  func(ctx context.Context, event *nostr.Event) (bool, string) {
    authenticatedUser := khatru.GetAuthed(ctx)
    if authenticatedUser == nPubToPubkey(config.OwnerNpub) {
      return false, ""
    }
    return true, "auth-required: publishing this event requires authentication"
})
```

### 2. Chat Relay (`/chat`)

**ç›®çš„**: Web of Trust å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã® DM/ãƒãƒ£ãƒƒãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Chat Relay (/chat)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚¢ã‚¯ã‚»ã‚¹: Web of Trust Members (NIP-42 Auth)       â”‚
â”‚ èª­ã¿å–ã‚Š: WoT Members                              â”‚
â”‚ æ›¸ãè¾¼ã¿: WoT Members                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¨±å¯ã•ã‚Œã‚‹ Kind:                                    â”‚
â”‚  - Kind 14: Chat Message                           â”‚
â”‚  - Kind 1059: Gift Wrap (encrypted DMs)            â”‚
â”‚  - Kind 9, 10, 11, 12: Simple Group kinds          â”‚
â”‚  - Kind 29: Simple Group Metadata                  â”‚
â”‚  - Kind 39, 40, 41: Channel kinds                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Web of Trust åˆ¤å®š:                                 â”‚
â”‚  âœ… Owner ã®ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆå†…                        â”‚
â”‚  âœ… ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ N-hop ä»¥å†…       â”‚
â”‚  âœ… æœ€å°ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã‚’æº€ãŸã™                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:                                       â”‚
â”‚  âœ… NIP-42 (Auth) å¿…é ˆ                             â”‚
â”‚  âœ… WoT ãƒ¡ãƒ³ãƒãƒ¼ä»¥å¤–ã¯æ‹’å¦                          â”‚
â”‚  âœ… Gift Wrap DM ã®ã¿å—ä»˜ (å¤ã„ NIP-04 ã¯æ‹’å¦)     â”‚
â”‚  âœ… Rate limiting                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:179-289`

**è¨±å¯ã•ã‚Œã‚‹ Event Kinds**:
```go
allowedKinds := []int{
  nostr.KindSimpleGroupChatMessage,         // 14
  nostr.KindSimpleGroupThreadedReply,       // 1111
  nostr.KindSimpleGroupThread,              // 11
  nostr.KindSimpleGroupReply,               // 12
  nostr.KindChannelMessage,                 // 42
  nostr.KindChannelHideMessage,             // 43
  nostr.KindGiftWrap,                       // 1059
  nostr.KindSimpleGroupPutUser,             // 9000
  nostr.KindSimpleGroupRemoveUser,          // 9001
  nostr.KindSimpleGroupEditMetadata,        // 9002
  nostr.KindSimpleGroupDeleteEvent,         // 9005
  nostr.KindSimpleGroupCreateGroup,         // 9006
  nostr.KindSimpleGroupDeleteGroup,         // 9007
  nostr.KindSimpleGroupCreateInvite,        // 9009
  nostr.KindSimpleGroupJoinRequest,         // 9021
  nostr.KindSimpleGroupLeaveRequest,        // 9022
  // Addressable kinds
  nostr.KindSimpleGroupMetadata,            // 39000
  nostr.KindSimpleGroupAdmins,              // 39001
  nostr.KindSimpleGroupMembers,             // 39002
  nostr.KindSimpleGroupRoles,               // 39003
}
```

### 3. Inbox Relay (`/inbox`)

**ç›®çš„**: ã‚ªãƒ¼ãƒŠãƒ¼å®›ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»Zap ãªã©ã‚’è‡ªå‹•åé›†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Inbox Relay (/inbox)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èª­ã¿å–ã‚Š: Public                                    â”‚
â”‚ æ›¸ãè¾¼ã¿: WoT Members (with p-tag to owner)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è‡ªå‹•åé›†ã•ã‚Œã‚‹ Event:                               â”‚
â”‚  - Kind 1: Text Note (replies)                    â”‚
â”‚  - Kind 6: Repost                                 â”‚
â”‚  - Kind 7: Reaction (likes, emojis)              â”‚
â”‚  - Kind 9735: Zap                                 â”‚
â”‚  - ãã®ä»– owner ã‚’ p-tag ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è‡ªå‹•åŒæœŸ:                                          â”‚
â”‚  âœ… Import seed relays ã‹ã‚‰å®šæœŸçš„ã« pull           â”‚
â”‚  âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­ (subscribeInboxAndChat)       â”‚
â”‚  âœ… é‡è¤‡ãƒã‚§ãƒƒã‚¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:                                     â”‚
â”‚  âœ… p-tag ã« owner pubkey ãŒå«ã¾ã‚Œã‚‹                â”‚
â”‚  âœ… WoT ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ (Gift Wrap ã¯é™¤å¤–)            â”‚
â”‚  âœ… å¤ã„ NIP-04 DM ã¯æ‹’å¦                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:411-485`, `import.go:166-227`

**è‡ªå‹•åŒæœŸãƒ­ã‚¸ãƒƒã‚¯**:
```go
func subscribeInboxAndChat() {
  ctx := context.Background()
  wdbInbox := eventstore.RelayWrapper{Store: inboxDB}
  wdbChat := eventstore.RelayWrapper{Store: chatDB}
  
  filter := nostr.Filter{
    Tags: nostr.TagMap{
      "p": {nPubToPubkey(config.OwnerNpub)},
    },
    Since: &startTime,
  }
  
  for ev := range pool.SubscribeMany(ctx, config.ImportSeedRelays, filter) {
    if !wotMap[ev.Event.PubKey] && ev.Event.Kind != nostr.KindGiftWrap {
      continue
    }
    
    // Route to inbox or chat based on kind
    if ev.Event.Kind == nostr.KindGiftWrap {
      dbToPublish = wdbChat
    } else {
      dbToPublish = wdbInbox
    }
    
    if !isDuplicate(ctx, dbToPublish, ev.Event) {
      dbToPublish.Publish(ctx, *ev.Event)
    }
  }
}
```

### 4. Outbox Relay (`/`)

**ç›®çš„**: ã‚ªãƒ¼ãƒŠãƒ¼ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒ¼ãƒˆã‚’é…ä¿¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Outbox Relay (/)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èª­ã¿å–ã‚Š: Public                                    â”‚
â”‚ æ›¸ãè¾¼ã¿: Owner Only                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é…ä¿¡ã•ã‚Œã‚‹ Event:                                   â”‚
â”‚  - Kind 0: Metadata                               â”‚
â”‚  - Kind 1: Text Note                              â”‚
â”‚  - Kind 3: Contacts                               â”‚
â”‚  - Kind 6: Repost                                 â”‚
â”‚  - Kind 7: Reaction                               â”‚
â”‚  - Kind 10002: Relay List Metadata               â”‚
â”‚  - Kind 30023: Long-form Content                 â”‚
â”‚  - ãã®ä»–å…¨ã¦ã® owner ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Blastr çµ±åˆ:                                        â”‚
â”‚  âœ… å…¨ã¦ã®æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ         â”‚
â”‚  âœ… è¨­å®šã—ãŸè¤‡æ•°ãƒªãƒ¬ãƒ¼ã«åŒæ™‚é…ä¿¡                    â”‚
â”‚  âœ… TorçµŒç”±ã§å¤–éƒ¨ãƒªãƒ¬ãƒ¼ã«é€ä¿¡                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Blossom çµ±åˆ:                                       â”‚
â”‚  âœ… åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ Blossom API æä¾›           â”‚
â”‚  âœ… GET/POST /upload                               â”‚
â”‚  âœ… GET /<sha256>                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:291-360`

**Blastr é€£æº**:
```go
outboxRelay.StoreEvent = append(outboxRelay.StoreEvent, 
  outboxDB.SaveEvent, 
  func(ctx context.Context, event *nostr.Event) error {
    go blast(event)  // éåŒæœŸã§ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    return nil
})
```

---

## ğŸŒ¸ Blossom ãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ãƒãƒ¼

### æ¦‚è¦

Blossom ã¯ Nostr ã®ãŸã‚ã®åˆ†æ•£å‹ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚Haven ã¯å®Œå…¨ãª Blossom ã‚µãƒ¼ãƒãƒ¼ã‚’çµ±åˆã—ã¦ã„ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Blossom Media Server                    â”‚
â”‚          (NIP-96 & BUD-02 Compliant)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoints:                                       â”‚
â”‚  - GET  /<sha256>         (Download blob)       â”‚
â”‚  - POST /upload           (Upload blob)         â”‚
â”‚  - GET  /list             (List blobs)          â”‚
â”‚  - DELETE /<sha256>       (Delete blob)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Storage:                                         â”‚
â”‚  - Location: /data/blossom/                     â”‚
â”‚  - Filename: SHA256 hash (no extension)         â”‚
â”‚  - Metadata: Stored in blossomDB                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Authentication:                                  â”‚
â”‚  âœ… Upload: Owner only (NIP-98 Auth)            â”‚
â”‚  âœ… Download: Public                             â”‚
â”‚  âœ… Delete: Owner only                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Supported Formats:                               â”‚
â”‚  - Images: jpg, jpeg, png, gif, webp            â”‚
â”‚  - Videos: mp4, mov, avi, mkv                   â”‚
â”‚  - Audio: mp3, wav, ogg, flac                   â”‚
â”‚  - Documents: pdf                                â”‚
â”‚  - Any binary file                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…è©³ç´°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:362-409`

```go
bl := blossom.New(outboxRelay, serviceURL)
bl.Store = blossom.EventStoreBlobIndexWrapper{
  Store: blossomDB, 
  ServiceURL: bl.ServiceURL,
}

// Upload (Store)
bl.StoreBlob = append(bl.StoreBlob, 
  func(ctx context.Context, sha256 string, ext string, body []byte) error {
    file, err := fs.Create(config.BlossomPath + "/" + sha256)
    if err != nil {
      return err
    }
    defer file.Close()
    
    if _, err := io.Copy(file, bytes.NewReader(body)); err != nil {
      return err
    }
    
    return nil
})

// Download (Load)
bl.LoadBlob = append(bl.LoadBlob, 
  func(ctx context.Context, sha256 string, ext string) (io.ReadSeeker, error) {
    file, err := fs.Open(config.BlossomPath + "/" + sha256)
    if err != nil {
      return nil, err
    }
    return file, nil
})

// Delete
bl.DeleteBlob = append(bl.DeleteBlob, 
  func(ctx context.Context, sha256 string, ext string) error {
    err := fs.Remove(config.BlossomPath + "/" + sha256)
    return err
})

// Access Control
bl.RejectUpload = append(bl.RejectUpload, 
  func(ctx context.Context, event *nostr.Event, size int, ext string) (bool, string, int) {
    if event.PubKey == nPubToPubkey(config.OwnerNpub) {
      return false, ext, size
    }
    return true, "only notes signed by the owner of this relay are allowed", 403
})
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¯¾å¿œçŠ¶æ³

| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | Blossom å¯¾å¿œ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------------|-------------|----------|
| **Amethyst** (Android) | âœ… Full Support | å®Œå…¨å‹•ä½œç¢ºèªæ¸ˆã¿ |
| **Damus** (iOS) | âš ï¸ Partial | NIP-96 ã®ã¿ |
| **Primal** | âš ï¸ Partial | ç”»åƒã®ã¿ |
| **Coracle** | âŒ No | - |
| **nostrudel** | âœ… Full Support | å®Œå…¨å‹•ä½œç¢ºèªæ¸ˆã¿ |

---

## ğŸ•¸ï¸ Web of Trust (WoT)

### æ¦‚å¿µ

Haven ã® WoT ã¯ã€ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚°ãƒ©ãƒ•ã«åŸºã¥ã„ã¦ã‚¹ãƒ‘ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Web of Trust Architecture               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Owner (You)
    â”‚
    â”œâ”€ Follows (0-hop / Direct Followers)
    â”‚    â”‚
    â”‚    â”œâ”€ Alice
    â”‚    â”œâ”€ Bob
    â”‚    â””â”€ Charlie
    â”‚
    â””â”€ 1-hop Network (Friends of Friends)
         â”‚
         â”œâ”€ Alice follows â†’ Dave, Eve
         â”œâ”€ Bob follows â†’ Frank, Grace
         â””â”€ Charlie follows â†’ Hannah, Isaac
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Filtering Criteria:                              â”‚
â”‚  1. Minimum Followers: 3 (configurable)         â”‚
â”‚  2. WoT Depth: 1 (configurable, 0=direct only)  â”‚
â”‚  3. Refresh Interval: 24 hours (configurable)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `wot.go`

```go
var (
  pubkeyFollowerCount = make(map[string]int)  // Follower count per pubkey
  oneHopNetwork       []string                 // 1-hop network pubkeys
  wot                 []string                 // Final WoT list
  wotMap              map[string]bool          // Fast lookup map
)

func refreshTrustNetwork() {
  // 1. Fetch owner's follow list (Kind 3)
  filter := nostr.Filter{
    Authors: []string{ownerPubkey},
    Kinds:   []int{nostr.KindFollowList},
  }
  
  events := pool.FetchMany(ctx, config.ImportSeedRelays, filter)
  for ev := range events {
    for contact := range ev.Event.Tags.FindAll("p") {
      pubkeyFollowerCount[contact[1]]++
      appendOneHopNetwork(contact[1])
    }
  }
  
  // 2. Fetch follow lists of 1-hop network
  for i := 0; i < len(oneHopNetwork); i += 100 {
    filter = nostr.Filter{
      Authors: oneHopNetwork[i:end],
      Kinds:   []int{nostr.KindFollowList, nostr.KindRelayListMetadata},
    }
    
    events := pool.FetchMany(ctx, config.ImportSeedRelays, filter)
    for ev := range events {
      for contact := range ev.Tags.FindAll("p") {
        pubkeyFollowerCount[contact[1]]++
      }
    }
  }
  
  // 3. Filter by minimum followers
  updateWoTMap()
}

func updateWoTMap() {
  wotMapTmp := make(map[string]bool)
  
  for pubkey, count := range pubkeyFollowerCount {
    if count >= config.ChatRelayMinimumFollowers {
      wotMapTmp[pubkey] = true
      appendPubkeyToWoT(pubkey)
    }
  }
  
  wotMap = wotMapTmp
}
```

### è¨­å®šé …ç›®

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | èª¬æ˜ |
|------|---------|------------|------|
| **WoT Depth** | `CHAT_RELAY_WOT_DEPTH` | `0` | 0=direct, 1=1-hop, 2=2-hop |
| **Minimum Followers** | `CHAT_RELAY_MINIMUM_FOLLOWERS` | `0` | æœ€å°ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•° |
| **Refresh Interval** | `CHAT_RELAY_WOT_REFRESH_INTERVAL_HOURS` | `0` (disabled) | WoT æ›´æ–°é–“éš” |
| **Fetch Timeout** | `WOT_FETCH_TIMEOUT_SECONDS` | `30` | ãƒ•ã‚§ãƒƒãƒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

### ä½¿ç”¨ç®‡æ‰€

1. **Chat Relay** (`/chat`)
   - èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿: WoT ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
   - Gift Wrap (Kind 1059) ã¯ä¾‹å¤–

2. **Inbox Relay** (`/inbox`)
   - æ›¸ãè¾¼ã¿: WoT ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ (p-tag ã« owner)
   - Gift Wrap ã¯ä¾‹å¤–

```go
// Chat relay filter check
chatRelay.RejectFilter = append(chatRelay.RejectFilter, 
  func(ctx context.Context, filter nostr.Filter) (bool, string) {
    authenticatedUser := khatru.GetAuthed(ctx)
    
    if !wotMap[authenticatedUser] {
      return true, "you must be in the web of trust to chat with the relay owner"
    }
    
    return false, ""
})

// Inbox relay event check
inboxRelay.RejectEvent = append(inboxRelay.RejectEvent, 
  func(ctx context.Context, event *nostr.Event) (bool, string) {
    if !wotMap[event.PubKey] {
      return true, "you must be in the web of trust to post to this relay"
    }
    
    if event.Kind == nostr.KindEncryptedDirectMessage {
      return true, "only gift wrapped DMs are supported"
    }
    
    if event.Tags.FindWithValue("p", inboxRelay.Info.PubKey) != nil {
      return false, ""
    }
    
    return true, "you can only post notes if you've tagged the owner of this relay"
})
```

---

## ğŸ“¦ Import æ©Ÿèƒ½

### æ¦‚è¦

Haven ã¯éå»ã®ãƒãƒ¼ãƒˆã‚’å¤–éƒ¨ãƒªãƒ¬ãƒ¼ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Import Architecture                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Owner Notes Import (importOwnerNotes)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Import Seed Relays                  â”‚
   â”‚  - relay.damus.io                   â”‚
   â”‚  - nos.lol                          â”‚
   â”‚  - relay.snort.social               â”‚
   â”‚  - ...                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Filter: authors=[owner_npub]
                     â”‚         since=IMPORT_START_DATE
                     â”‚         until=start+10days
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Owner Notes â”‚â”€â”€â†’ Outbox DB
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Tagged Notes Import (importTaggedNotes)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Import Seed Relays                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Filter: #p=[owner_npub]
                     â”‚         (all history)
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Tagged Notes     â”‚
              â”‚  - Replies       â”‚â”€â”€â†’ Inbox DB
              â”‚  - Reactions     â”‚
              â”‚  - Zaps          â”‚
              â”‚  - Gift Wraps    â”‚â”€â”€â†’ Chat DB
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Continuous Sync (subscribeInboxAndChat)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Import Seed Relays                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Subscribe: #p=[owner_npub]
                     â”‚            since=now-5min
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Real-time Events â”‚
              â”‚  (auto-imported) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…è©³ç´°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `import.go`

#### 1. Owner Notes Import

```go
func importOwnerNotes() {
  wdb := eventstore.RelayWrapper{Store: outboxDB}
  
  startTime, _ := time.Parse(layout, config.ImportStartDate)
  endTime := startTime.Add(240 * time.Hour)  // 10 days batch
  
  for {
    filter := nostr.Filter{
      Authors: []string{nPubToPubkey(config.OwnerNpub)},
      Since:   &startTimestamp,
      Until:   &endTimestamp,
    }
    
    ctx, cancel := context.WithTimeout(context.Background(), timeout)
    
    events := pool.FetchMany(ctx, config.ImportSeedRelays, filter)
    for ev := range events {
      if err := wdb.Publish(ctx, *ev.Event); err != nil {
        log.Println("error importing note", ev.ID, ":", err)
      }
    }
    
    startTime = startTime.Add(240 * time.Hour)
    endTime = endTime.Add(240 * time.Hour)
    
    if startTime.After(time.Now()) {
      break
    }
  }
}
```

**ç‰¹å¾´**:
- 10æ—¥ã”ã¨ã®ãƒãƒƒãƒå‡¦ç†
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šå¯èƒ½
- é€²æ—ãƒ­ã‚°
- å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ

#### 2. Tagged Notes Import

```go
func importTaggedNotes() {
  wdbInbox := eventstore.RelayWrapper{Store: inboxDB}
  wdbChat := eventstore.RelayWrapper{Store: chatDB}
  
  filter := nostr.Filter{
    Tags: nostr.TagMap{
      "p": {nPubToPubkey(config.OwnerNpub)},
    },
  }
  
  ctx, cancel := context.WithTimeout(context.Background(), timeout)
  defer cancel()
  
  events := pool.FetchMany(ctx, config.ImportSeedRelays, filter)
  for ev := range events {
    // WoT check
    if !wotMap[ev.PubKey] && ev.Kind != nostr.KindGiftWrap {
      continue
    }
    
    // Route to appropriate DB
    dbToWrite := wdbInbox
    if ev.Kind == nostr.KindGiftWrap {
      dbToWrite = wdbChat
    }
    
    if err := dbToWrite.Publish(ctx, *ev.Event); err != nil {
      log.Println("error importing tagged note", ev.ID, ":", err)
    }
  }
}
```

**ç‰¹å¾´**:
- å…¨å±¥æ­´ã‚’ä¸€åº¦ã«å–å¾—
- WoT ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- Gift Wrap ã¯ Chat DB ã¸
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šå¯èƒ½

#### 3. Continuous Sync

```go
func subscribeInboxAndChat() {
  ctx := context.Background()
  wdbInbox := eventstore.RelayWrapper{Store: inboxDB}
  wdbChat := eventstore.RelayWrapper{Store: chatDB}
  
  startTime := nostr.Timestamp(time.Now().Add(-time.Minute * 5).Unix())
  filter := nostr.Filter{
    Tags: nostr.TagMap{
      "p": {nPubToPubkey(config.OwnerNpub)},
    },
    Since: &startTime,
  }
  
  for ev := range pool.SubscribeMany(ctx, config.ImportSeedRelays, filter) {
    // WoT check
    if !wotMap[ev.Event.PubKey] && ev.Event.Kind != nostr.KindGiftWrap {
      continue
    }
    
    // Duplicate check
    if isDuplicate(ctx, dbToPublish, ev.Event) {
      continue
    }
    
    // Route and publish
    dbToPublish := wdbInbox
    if ev.Event.Kind == nostr.KindGiftWrap {
      dbToPublish = wdbChat
    }
    
    if err := dbToPublish.Publish(ctx, *ev.Event); err != nil {
      log.Println("error importing tagged note", ev.Event.ID)
    }
    
    // Log notification
    switch ev.Event.Kind {
    case nostr.KindTextNote:
      log.Println("ğŸ“° new note in your inbox")
    case nostr.KindReaction:
      log.Println(ev.Event.Content, "new reaction in your inbox")
    case nostr.KindZap:
      log.Println("âš¡ï¸ new zap in your inbox")
    case nostr.KindGiftWrap:
      log.Println("ğŸğŸ”’ï¸âœ‰ï¸ new gift-wrapped message in your chat relay")
    }
  }
}
```

### Start9 çµ±åˆ

**Action**: `import-notes` (manifest.yaml:203-245)

```yaml
actions:
  import-notes:
    name: Import Past Notes
    description: |
      Configure Haven to import your past notes and mentions on next restart.
    warning: |
      âš ï¸ IMPORTANT: After running this action, you MUST restart Haven!
    implementation:
      type: docker
      image: main
      entrypoint: docker_entrypoint.sh
      args: ["import-notes"]
```

**ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Start9 UI ã§ "Import Past Notes" ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
2. `.import-request` ãƒ•ãƒ©ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
3. Haven ã‚’å†èµ·å‹•
4. `docker_entrypoint.sh` ãŒ `--import` ãƒ•ãƒ©ã‚°ä»˜ãã§ Haven ã‚’èµ·å‹•
5. Import å®Ÿè¡Œ
6. å®Œäº†å¾Œã€Haven ã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§è‡ªå‹•å†èµ·å‹•

### è¨­å®šé …ç›®

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | èª¬æ˜ |
|------|---------|------------|------|
| **Start Date** | `IMPORT_START_DATE` | - | ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹æ—¥ (YYYY-MM-DD) |
| **Owner Notes Timeout** | `IMPORT_OWNER_NOTES_FETCH_TIMEOUT_SECONDS` | `30` | Owner ãƒãƒ¼ãƒˆå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| **Tagged Notes Timeout** | `IMPORT_TAGGED_NOTES_FETCH_TIMEOUT_SECONDS` | `120` | Tagged ãƒãƒ¼ãƒˆå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| **Query Interval** | `IMPORT_QUERY_INTERVAL_SECONDS` | `360000` | å®šæœŸã‚¯ã‚¨ãƒªé–“éš” (æœªä½¿ç”¨) |
| **Seed Relays** | `IMPORT_SEED_RELAYS_FILE` | - | ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆ (JSON) |
| **Inbox Pull Interval** | `INBOX_PULL_INTERVAL_SECONDS` | `3600` | Inbox åŒæœŸé–“éš” |

---

## ğŸ”« Blastr æ©Ÿèƒ½

### æ¦‚è¦

Blastr ã¯ Haven ã® Outbox ã«æŠ•ç¨¿ã•ã‚ŒãŸãƒãƒ¼ãƒˆã‚’è‡ªå‹•çš„ã«è¤‡æ•°ã®å¤–éƒ¨ãƒªãƒ¬ãƒ¼ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Blastr Architecture                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client
  â”‚
  â”‚ WebSocket Publish
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Outbox Relay    â”‚
â”‚    (/)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Save to outboxDB
         â”‚
         â””â”€ blast(event) â”€â”€â”
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Blastr Relay Pool         â”‚
              â”‚  (config.BlastrRelays)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼          â–¼          â–¼
           relay.damus.io  nos.lol  relay.snort.social
              (IPv4)     (IPv6)       (Tor)
```

### å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `blastr.go`

```go
func blast(ev *nostr.Event) {
  ctx := context.Background()
  
  for _, url := range config.BlastrRelays {
    // Extended timeout for Tor connections (15 seconds)
    ctx, cancel := context.WithTimeout(ctx, time.Second*15)
    
    relay, err := pool.EnsureRelay(url)
    if err != nil {
      cancel()
      log.Println("error connecting to relay", relay, err)
      continue
    }
    
    if err := relay.Publish(ctx, *ev); err != nil {
      log.Println("ğŸš« error publishing to relay", relay, err)
    }
    
    cancel()
  }
  
  log.Println("ğŸ”« blasted", ev.ID, "to", len(config.BlastrRelays), "relays")
}
```

**ç‰¹å¾´**:
- éåŒæœŸå®Ÿè¡Œ (`go blast(event)`)
- 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (Tor å¯¾å¿œ)
- IPv6 ã‚µãƒãƒ¼ãƒˆ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ­ã‚°å‡ºåŠ›

### çµ±åˆãƒã‚¤ãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:324-327`

```go
outboxRelay.StoreEvent = append(outboxRelay.StoreEvent, 
  outboxDB.SaveEvent,
  func(ctx context.Context, event *nostr.Event) error {
    go blast(event)  // éåŒæœŸã§ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    return nil
})
```

### è¨­å®š

**Start9 UI**: Config > Blastr Relay List (CSV format)

```
relay.damus.io,nos.lol,relay.snort.social,relay.nostr.band,nostr.mom,relay.primal.net,offchain.pub,nostr.bitcoiner.social
```

**ç’°å¢ƒå¤‰æ•°**: `BLASTR_RELAYS_FILE` â†’ `relays_blastr.json`

```json
[
  "wss://relay.damus.io",
  "wss://nos.lol",
  "wss://relay.snort.social",
  "wss://relay.nostr.band",
  "wss://nostr.mom",
  "wss://relay.primal.net",
  "wss://offchain.pub",
  "wss://nostr.bitcoiner.social"
]
```

### IPv6 ã‚µãƒãƒ¼ãƒˆ

**å®Ÿè£…** (v1.1.3):
- Tor è¨­å®š: `ClientUseIPv6 1`, `ClientPreferIPv6ORPort 1`, `IPv6Exit 1`
- Go ã® Happy Eyeballs v2 (RFC 8305) ã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- IPv6 å„ªå…ˆã€300ms å¾Œã« IPv4 ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

## â˜ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½

### æ¦‚è¦

Haven ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®šæœŸçš„ã« S3 äº’æ›ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Backup Architecture                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Haven Process
  â”‚
  â”‚ Every BACKUP_INTERVAL_HOURS
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ backupDatabase()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. ZIP database
         â”‚    db/ â†’ db.zip
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  db.zip  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Upload to cloud
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3-Compatible Storage  â”‚
â”‚  - AWS S3               â”‚
â”‚  - GCP Cloud Storage    â”‚
â”‚  - DigitalOcean Spaces  â”‚
â”‚  - Wasabi               â”‚
â”‚  - Backblaze B2         â”‚
â”‚  - MinIO                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. Delete local db.zip
         â–¼
       (Done)
```

### å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backup.go`

```go
func backupDatabase() {
  if config.BackupProvider == "none" || config.BackupProvider == "" {
    log.Println("ğŸš« no backup provider set")
    return
  }
  
  ticker := time.NewTicker(time.Duration(config.BackupIntervalHours) * time.Hour)
  defer ticker.Stop()
  
  zipFileName := "db.zip"
  
  for {
    select {
    case <-ticker.C:
      // 1. ZIP the database
      if err := ZipDirectory("db", zipFileName); err != nil {
        log.Println("ğŸš« error zipping database folder:", err)
        continue
      }
      
      // 2. Upload to cloud
      switch config.BackupProvider {
      case "s3":
        S3Upload(zipFileName)
      case "aws":
        AwsUpload(zipFileName)  // Deprecated
      case "gcp":
        GCPBucketUpload(zipFileName)  // Deprecated
      default:
        log.Println("ğŸš« we only support AWS, GCP, and S3 at this time")
      }
    }
  }
}
```

#### S3 Upload

```go
func S3Upload(zipFileName string) {
  // Create MinIO client (S3-compatible)
  client, err := minio.New(endpoint, &minio.Options{
    Creds:  credentials.NewStaticV4(accessKey, secret, ""),
    Region: region,
    Secure: secure,
  })
  
  // Upload file
  file, err := os.Open(zipFileName)
  defer file.Close()
  
  fileInfo, _ := file.Stat()
  
  _, err = client.PutObject(
    context.Background(),
    bucketName,
    zipFileName,
    file,
    fileInfo.Size(),
    minio.PutObjectOptions{
      ContentType: "application/octet-stream",
    },
  )
  
  // Delete local file
  os.Remove(zipFileName)
}
```

#### ZIP Database

```go
func ZipDirectory(sourceDir, zipFileName string) error {
  file, err := os.Create(zipFileName)
  defer file.Close()
  
  w := zip.NewWriter(file)
  defer w.Close()
  
  walker := func(path string, info os.FileInfo, err error) error {
    if info.IsDir() {
      return nil
    }
    
    file, err := os.Open(path)
    defer file.Close()
    
    f, err := w.Create(path)
    _, err = io.Copy(f, file)
    
    return nil
  }
  
  err = filepath.Walk(sourceDir, walker)
  return nil
}
```

### è¨­å®šé …ç›®

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | èª¬æ˜ |
|------|---------|------------|------|
| **Backup Provider** | `BACKUP_PROVIDER` | `none` | `s3`, `aws`, `gcp`, `none` |
| **Backup Interval** | `BACKUP_INTERVAL_HOURS` | `24` | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–“éš” (æ™‚é–“) |
| **S3 Access Key** | `S3_ACCESS_KEY_ID` | - | S3 ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ |
| **S3 Secret Key** | `S3_SECRET_KEY` | - | S3 ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ |
| **S3 Endpoint** | `S3_ENDPOINT` | - | S3 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| **S3 Region** | `S3_REGION` | - | S3 ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
| **S3 Bucket** | `S3_BUCKET_NAME` | - | S3 ãƒã‚±ãƒƒãƒˆå |

### Start9 ã§ã®åˆ©ç”¨

Start9 ã§ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ **Start9 ã®å†…è”µãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Haven ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ (`BACKUP_PROVIDER=none`)ã€‚

Start9 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:
- `manifest.yaml:backup.create` ã§å®šç¾©
- Duplicity ã‚’ä½¿ç”¨
- Start9 ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆ (å¤–éƒ¨ HDD, NAS, etc.) ã«ä¿å­˜

---

## ğŸš§ Rate Limiting

### æ¦‚è¦

Haven ã¯ IP ãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Rate Limiting Architecture              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Connection      â”‚â”€â”€â”€â†’ Connection Rate Limiter
â”‚ Established     â”‚     (per IP, per minute)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Published â”‚â”€â”€â”€â†’ Event Rate Limiter
â”‚                 â”‚     (per IP, per minute)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `limits.go`, `init.go`

#### Token Bucket Algorithm

Haven ã¯ Khatru ã®ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨:
- `policies.EventIPRateLimiter`
- `policies.ConnectionRateLimiter`

```go
// Event rate limiting
privateRelay.RejectEvent = append(privateRelay.RejectEvent,
  policies.EventIPRateLimiter(
    tokensPerInterval,  // æ–°è¦ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    interval,           // è£œå……é–“éš” (åˆ†)
    maxTokens,          // æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  ),
)

// Connection rate limiting
privateRelay.RejectConnection = append(privateRelay.RejectConnection,
  policies.ConnectionRateLimiter(
    tokensPerInterval,  // æ–°è¦ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    interval,           // è£œå……é–“éš” (åˆ†)
    maxTokens,          // æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  ),
)
```

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š

| Relay | Event Tokens/Min | Event Max | Conn Tokens/Min | Conn Max |
|-------|-----------------|-----------|----------------|----------|
| **Private** | 50 | 100 | 3 | 9 |
| **Chat** | 50 | 100 | 3 | 9 |
| **Inbox** | 10 | 20 | 3 | 9 |
| **Outbox** | 10 | 100 | 3 | 9 |

### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¶é™

```go
type RelayLimits struct {
  EventIPLimiterTokensPerInterval        int
  EventIPLimiterInterval                 int
  EventIPLimiterMaxTokens                int
  AllowEmptyFilters                      bool   // ç©ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨±å¯
  AllowComplexFilters                    bool   // è¤‡é›‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨±å¯
  ConnectionRateLimiterTokensPerInterval int
  ConnectionRateLimiterInterval          int
  ConnectionRateLimiterMaxTokens         int
}
```

**Empty Filter**: `{}` (å…¨ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—)  
**Complex Filter**: è¤‡æ•°ã® `authors`, `kinds`, `#e`, `#p` ãªã©

```go
if !privateRelayLimits.AllowEmptyFilters {
  privateRelay.RejectFilter = append(privateRelay.RejectFilter, 
    policies.NoEmptyFilters)
}

if !privateRelayLimits.AllowComplexFilters {
  privateRelay.RejectFilter = append(privateRelay.RejectFilter, 
    policies.NoComplexFilters)
}
```

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

**ç’°å¢ƒå¤‰æ•°ä¾‹**:

```bash
# Private Relay
PRIVATE_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL=50
PRIVATE_RELAY_EVENT_IP_LIMITER_INTERVAL=1
PRIVATE_RELAY_EVENT_IP_LIMITER_MAX_TOKENS=100
PRIVATE_RELAY_ALLOW_EMPTY_FILTERS=true
PRIVATE_RELAY_ALLOW_COMPLEX_FILTERS=true
PRIVATE_RELAY_CONNECTION_RATE_LIMITER_TOKENS_PER_INTERVAL=3
PRIVATE_RELAY_CONNECTION_RATE_LIMITER_INTERVAL=5
PRIVATE_RELAY_CONNECTION_RATE_LIMITER_MAX_TOKENS=9

# Chat Relay
CHAT_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL=50
CHAT_RELAY_EVENT_IP_LIMITER_INTERVAL=1
CHAT_RELAY_EVENT_IP_LIMITER_MAX_TOKENS=100
CHAT_RELAY_ALLOW_EMPTY_FILTERS=false
CHAT_RELAY_ALLOW_COMPLEX_FILTERS=false
...
```

---

## ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### ã‚µãƒãƒ¼ãƒˆ

Haven ã¯ 2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™:

1. **LMDB** (Lightning Memory-Mapped Database) - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
2. **BadgerDB** - ä»£æ›¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Database Architecture                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DBBackend Interface
    â”‚
    â”œâ”€ Init() error
    â”œâ”€ Close()
    â”œâ”€ CountEvents(ctx, filter) (int64, error)
    â”œâ”€ DeleteEvent(ctx, evt) error
    â”œâ”€ QueryEvents(ctx, filter) (chan *nostr.Event, error)
    â”œâ”€ SaveEvent(ctx, evt) error
    â”œâ”€ ReplaceEvent(ctx, evt) error
    â””â”€ Serial() []byte
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  LMDB   â”‚      â”‚ BadgerDBâ”‚      â”‚ (Future)â”‚
    â”‚ Backend â”‚      â”‚ Backend â”‚      â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `init.go:42-71`

```go
type DBBackend interface {
  Init() error
  Close()
  CountEvents(ctx context.Context, filter nostr.Filter) (int64, error)
  DeleteEvent(ctx context.Context, evt *nostr.Event) error
  QueryEvents(ctx context.Context, filter nostr.Filter) (chan *nostr.Event, error)
  SaveEvent(ctx context.Context, evt *nostr.Event) error
  ReplaceEvent(ctx context.Context, evt *nostr.Event) error
  Serial() []byte
}

func newDBBackend(path string) DBBackend {
  switch config.DBEngine {
  case "lmdb":
    return newLMDBBackend(path)
  case "badger":
    return &badger.BadgerBackend{
      Path: path,
    }
  default:
    return newLMDBBackend(path)
  }
}

func newLMDBBackend(path string) *lmdb.LMDBBackend {
  return &lmdb.LMDBBackend{
    Path:    path,
    MapSize: config.LmdbMapSize,
  }
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–

```go
func initRelays() {
  if err := privateDB.Init(); err != nil {
    panic(err)
  }
  
  if err := chatDB.Init(); err != nil {
    panic(err)
  }
  
  if err := outboxDB.Init(); err != nil {
    panic(err)
  }
  
  if err := inboxDB.Init(); err != nil {
    panic(err)
  }
  
  if err := blossomDB.Init(); err != nil {
    panic(err)
  }
  
  // ... relay configuration ...
}
```

### LMDB vs BadgerDB

| ç‰¹å¾´ | LMDB | BadgerDB |
|------|------|----------|
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | âš¡ Very Fast (NVMe) | âš¡ Fast |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨** | ğŸŸ¢ Low | ğŸŸ¡ Medium |
| **ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨** | ğŸŸ¢ Efficient | ğŸŸ¡ More overhead |
| **Map Size** | âš ï¸ è¦è¨­å®š | âœ… Auto-expand |
| **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ** | Linux, macOS, Windows | All |
| **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | âš ï¸ Breaking changes | âš ï¸ Breaking changes |

### è¨­å®šé …ç›®

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | èª¬æ˜ |
|------|---------|------------|------|
| **DB Engine** | `DB_ENGINE` | `lmdb` | `lmdb` or `badger` |
| **LMDB Map Size** | `LMDB_MAPSIZE` | `0` (auto) | LMDB ã®ãƒãƒƒãƒ—ã‚µã‚¤ã‚º (bytes) |

### LMDB Map Size

**é‡è¦**: LMDB ã¯äº‹å‰ã«æœ€å¤§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 273 GB (è‡ªå‹•è¨ˆç®—)
LMDB_MAPSIZE=0

# ã‚«ã‚¹ã‚¿ãƒ : 100 GB
LMDB_MAPSIZE=107374182400

# Windows/macOS: ç©ºããƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚ˆã‚Šå°ã•ã„å€¤ã‚’è¨­å®š
LMDB_MAPSIZE=10737418240  # 10 GB
```

**ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**:
- Linux: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (0) ã§ OK
- macOS: ç©ºããƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã® 50% ä»¥ä¸‹
- Windows: ç©ºããƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã® 50% ä»¥ä¸‹
- å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: å¿…è¦ã«å¿œã˜ã¦å¢—åŠ 

---

## âš™ï¸ è¨­å®šé …ç›®

### å®Œå…¨ãªè¨­å®šé …ç›®ãƒªã‚¹ãƒˆ

#### åŸºæœ¬è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Owner Npub** | `OWNER_NPUB` | - | âœ… | ãƒªãƒ¬ãƒ¼ã‚ªãƒ¼ãƒŠãƒ¼ã® npub |
| **Relay URL** | `RELAY_URL` | - | âœ… | ãƒªãƒ¬ãƒ¼ã® URL (Tor: .onion) |
| **Relay Port** | `RELAY_PORT` | `3355` | - | ãƒªãƒ¬ãƒ¼ã®ãƒãƒ¼ãƒˆ |
| **Relay Bind Address** | `RELAY_BIND_ADDRESS` | `0.0.0.0` | - | ãƒã‚¤ãƒ³ãƒ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| **Log Level** | `HAVEN_LOG_LEVEL` | `INFO` | - | `DEBUG`, `INFO`, `WARN`, `ERROR` |

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **DB Engine** | `DB_ENGINE` | `lmdb` | - | `lmdb` or `badger` |
| **LMDB Map Size** | `LMDB_MAPSIZE` | `0` | - | LMDB ãƒãƒƒãƒ—ã‚µã‚¤ã‚º (bytes) |

#### Blossom è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Blossom Path** | `BLOSSOM_PATH` | `blossom` | - | ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ‘ã‚¹ |

#### Private Relay è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Name** | `PRIVATE_RELAY_NAME` | - | âœ… | ãƒªãƒ¬ãƒ¼å |
| **Npub** | `PRIVATE_RELAY_NPUB` | - | âœ… | ãƒªãƒ¬ãƒ¼ã® npub |
| **Description** | `PRIVATE_RELAY_DESCRIPTION` | - | âœ… | ãƒªãƒ¬ãƒ¼ã®èª¬æ˜ |
| **Icon** | `PRIVATE_RELAY_ICON` | - | - | ãƒªãƒ¬ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ URL |

#### Chat Relay è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Name** | `CHAT_RELAY_NAME` | - | âœ… | ãƒªãƒ¬ãƒ¼å |
| **Npub** | `CHAT_RELAY_NPUB` | - | âœ… | ãƒªãƒ¬ãƒ¼ã® npub |
| **Description** | `CHAT_RELAY_DESCRIPTION` | - | âœ… | ãƒªãƒ¬ãƒ¼ã®èª¬æ˜ |
| **Icon** | `CHAT_RELAY_ICON` | - | - | ãƒªãƒ¬ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ URL |
| **WoT Depth** | `CHAT_RELAY_WOT_DEPTH` | `0` | - | WoT æ·±ã• (0=direct, 1=1-hop) |
| **WoT Refresh Interval** | `CHAT_RELAY_WOT_REFRESH_INTERVAL_HOURS` | `0` | - | WoT æ›´æ–°é–“éš” (æ™‚é–“) |
| **Minimum Followers** | `CHAT_RELAY_MINIMUM_FOLLOWERS` | `0` | - | æœ€å°ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•° |

#### Inbox Relay è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Name** | `INBOX_RELAY_NAME` | - | âœ… | ãƒªãƒ¬ãƒ¼å |
| **Npub** | `INBOX_RELAY_NPUB` | - | âœ… | ãƒªãƒ¬ãƒ¼ã® npub |
| **Description** | `INBOX_RELAY_DESCRIPTION` | - | âœ… | ãƒªãƒ¬ãƒ¼ã®èª¬æ˜ |
| **Icon** | `INBOX_RELAY_ICON` | - | - | ãƒªãƒ¬ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ URL |
| **Pull Interval** | `INBOX_PULL_INTERVAL_SECONDS` | `3600` | - | Inbox åŒæœŸé–“éš” (ç§’) |

#### Outbox Relay è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Name** | `OUTBOX_RELAY_NAME` | - | âœ… | ãƒªãƒ¬ãƒ¼å |
| **Npub** | `OUTBOX_RELAY_NPUB` | - | âœ… | ãƒªãƒ¬ãƒ¼ã® npub |
| **Description** | `OUTBOX_RELAY_DESCRIPTION` | - | âœ… | ãƒªãƒ¬ãƒ¼ã®èª¬æ˜ |
| **Icon** | `OUTBOX_RELAY_ICON` | - | - | ãƒªãƒ¬ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ URL |

#### Import è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Start Date** | `IMPORT_START_DATE` | - | - | ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹æ—¥ (YYYY-MM-DD) |
| **Owner Notes Timeout** | `IMPORT_OWNER_NOTES_FETCH_TIMEOUT_SECONDS` | `30` | - | Owner ãƒãƒ¼ãƒˆå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| **Tagged Notes Timeout** | `IMPORT_TAGGED_NOTES_FETCH_TIMEOUT_SECONDS` | `120` | - | Tagged ãƒãƒ¼ãƒˆå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| **Query Interval** | `IMPORT_QUERY_INTERVAL_SECONDS` | `360000` | - | å®šæœŸã‚¯ã‚¨ãƒªé–“éš” |
| **Seed Relays File** | `IMPORT_SEED_RELAYS_FILE` | - | - | ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆ |

#### Blastr è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Blastr Relays File** | `BLASTR_RELAYS_FILE` | - | - | Blastr ãƒªãƒ¬ãƒ¼ãƒªã‚¹ãƒˆ |

#### WoT è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Fetch Timeout** | `WOT_FETCH_TIMEOUT_SECONDS` | `30` | - | WoT ãƒ•ã‚§ãƒƒãƒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

#### Backup è¨­å®š

| é …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ | èª¬æ˜ |
|------|---------|------------|------|------|
| **Backup Provider** | `BACKUP_PROVIDER` | `none` | - | `s3`, `aws`, `gcp`, `none` |
| **Backup Interval** | `BACKUP_INTERVAL_HOURS` | `24` | - | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–“éš” (æ™‚é–“) |
| **S3 Access Key** | `S3_ACCESS_KEY_ID` | - | - | S3 ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ |
| **S3 Secret Key** | `S3_SECRET_KEY` | - | - | S3 ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ |
| **S3 Endpoint** | `S3_ENDPOINT` | - | - | S3 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| **S3 Region** | `S3_REGION` | - | - | S3 ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
| **S3 Bucket** | `S3_BUCKET_NAME` | - | - | S3 ãƒã‚±ãƒƒãƒˆå |

#### Rate Limiting è¨­å®š (å„ãƒªãƒ¬ãƒ¼ã”ã¨)

**Private Relay**:
- `PRIVATE_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL` (default: `50`)
- `PRIVATE_RELAY_EVENT_IP_LIMITER_INTERVAL` (default: `1`)
- `PRIVATE_RELAY_EVENT_IP_LIMITER_MAX_TOKENS` (default: `100`)
- `PRIVATE_RELAY_ALLOW_EMPTY_FILTERS` (default: `true`)
- `PRIVATE_RELAY_ALLOW_COMPLEX_FILTERS` (default: `true`)
- `PRIVATE_RELAY_CONNECTION_RATE_LIMITER_TOKENS_PER_INTERVAL` (default: `3`)
- `PRIVATE_RELAY_CONNECTION_RATE_LIMITER_INTERVAL` (default: `5`)
- `PRIVATE_RELAY_CONNECTION_RATE_LIMITER_MAX_TOKENS` (default: `9`)

**Chat Relay**:
- `CHAT_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL` (default: `50`)
- `CHAT_RELAY_EVENT_IP_LIMITER_INTERVAL` (default: `1`)
- `CHAT_RELAY_EVENT_IP_LIMITER_MAX_TOKENS` (default: `100`)
- `CHAT_RELAY_ALLOW_EMPTY_FILTERS` (default: `false`)
- `CHAT_RELAY_ALLOW_COMPLEX_FILTERS` (default: `false`)
- `CHAT_RELAY_CONNECTION_RATE_LIMITER_TOKENS_PER_INTERVAL` (default: `3`)
- `CHAT_RELAY_CONNECTION_RATE_LIMITER_INTERVAL` (default: `3`)
- `CHAT_RELAY_CONNECTION_RATE_LIMITER_MAX_TOKENS` (default: `9`)

**Inbox Relay**:
- `INBOX_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL` (default: `10`)
- `INBOX_RELAY_EVENT_IP_LIMITER_INTERVAL` (default: `1`)
- `INBOX_RELAY_EVENT_IP_LIMITER_MAX_TOKENS` (default: `20`)
- `INBOX_RELAY_ALLOW_EMPTY_FILTERS` (default: `false`)
- `INBOX_RELAY_ALLOW_COMPLEX_FILTERS` (default: `false`)
- `INBOX_RELAY_CONNECTION_RATE_LIMITER_TOKENS_PER_INTERVAL` (default: `3`)
- `INBOX_RELAY_CONNECTION_RATE_LIMITER_INTERVAL` (default: `1`)
- `INBOX_RELAY_CONNECTION_RATE_LIMITER_MAX_TOKENS` (default: `9`)

**Outbox Relay**:
- `OUTBOX_RELAY_EVENT_IP_LIMITER_TOKENS_PER_INTERVAL` (default: `10`)
- `OUTBOX_RELAY_EVENT_IP_LIMITER_INTERVAL` (default: `60`)
- `OUTBOX_RELAY_EVENT_IP_LIMITER_MAX_TOKENS` (default: `100`)
- `OUTBOX_RELAY_ALLOW_EMPTY_FILTERS` (default: `false`)
- `OUTBOX_RELAY_ALLOW_COMPLEX_FILTERS` (default: `false`)
- `OUTBOX_RELAY_CONNECTION_RATE_LIMITER_TOKENS_PER_INTERVAL` (default: `3`)
- `OUTBOX_RELAY_CONNECTION_RATE_LIMITER_INTERVAL` (default: `1`)
- `OUTBOX_RELAY_CONNECTION_RATE_LIMITER_MAX_TOKENS` (default: `9`)

---

## ğŸ¯ Start9 çµ±åˆçŠ¶æ³

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ (v1.1.5)

| æ©Ÿèƒ½ | å®Ÿè£…çŠ¶æ³ | Start9 å¯¾å¿œ | å‚™è€ƒ |
|------|---------|-----------|------|
| **Private Relay** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | NIP-42 Auth å®Œå…¨å‹•ä½œ |
| **Chat Relay** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | WoT + Auth å®Œå…¨å‹•ä½œ |
| **Inbox Relay** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | è‡ªå‹•åŒæœŸå‹•ä½œç¢ºèªæ¸ˆã¿ |
| **Outbox Relay** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | Blastr çµ±åˆæ¸ˆã¿ |
| **Blossom Server** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | Amethyst ã§å‹•ä½œç¢ºèª |
| **Web of Trust** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | è‡ªå‹•æ›´æ–°å‹•ä½œ |
| **Import (Owner)** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | Action å®Ÿè£…æ¸ˆã¿ |
| **Import (Tagged)** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | Action å®Ÿè£…æ¸ˆã¿ |
| **Import (Continuous)** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œ |
| **Blastr** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | IPv6 + Tor å¯¾å¿œ |
| **Cloud Backup** | âœ… å®Œäº† | âš ï¸ ç„¡åŠ¹åŒ– | Start9 å†…è”µãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½¿ç”¨ |
| **Tor Integration** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | .onion å›ºå®šåŒ–æ¸ˆã¿ |
| **Config UI** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | å…¨è¨­å®šé …ç›®å¯¾å¿œ |
| **Health Check** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | Web interface ãƒã‚§ãƒƒã‚¯ |
| **Properties** | âœ… å®Œäº† | âœ… å®Œå…¨å¯¾å¿œ | .onion address è¡¨ç¤º |

### Start9 å›ºæœ‰ã®å®Ÿè£…

#### 1. Tor çµ±åˆ

**å®Ÿè£…**: `docker_entrypoint.sh`, `torrc`

```bash
# Start Tor
echo "Starting Tor..."
/usr/local/bin/tor -f /etc/tor/torrc &

# Wait for Tor to generate .onion address
while [ ! -f /data/tor/haven/hostname ]; do
    echo "Waiting for Tor hidden service to initialize..."
    sleep 1
done

ONION_ADDRESS=$(cat /data/tor/haven/hostname)
echo "Tor hidden service: $ONION_ADDRESS"
```

**Tor è¨­å®š** (`torrc`):
```
HiddenServiceDir /data/tor/haven/
HiddenServicePort 80 127.0.0.1:3355
ClientUseIPv6 1
ClientPreferIPv6ORPort 1
IPv6Exit 1
```

#### 2. Config Management

**Get Config**: `scripts/procedures/getConfig.ts`
**Set Config**: `scripts/procedures/setConfig.ts`

Start9 UI ã¨ Haven ã® `.env` è¨­å®šã‚’åŒæ–¹å‘åŒæœŸã€‚

#### 3. Import Action

**å®Ÿè£…**: `docker_entrypoint.sh`

```bash
if [ "$1" = "import-notes" ]; then
    echo "Setting up import request..."
    touch /data/.import-request
    echo "Import will run on next Haven restart."
    exit 0
fi

# Check if import is requested
if [ -f /data/.import-request ]; then
    echo "Import requested, starting Haven in import mode..."
    rm /data/.import-request
    
    cd /haven
    ./haven --import
    
    echo "Import complete, restarting in normal mode..."
fi
```

#### 4. Properties Display

**å®Ÿè£…**: `scripts/procedures/properties.ts`

```typescript
export const properties: T.ExpectedExports.properties = async (effects) => {
  const onionAddress = await effects.readFile({
    path: '/data/tor/haven/hostname',
    volumeId: 'main',
  })

  return {
    'Haven Relay': {
      type: 'string',
      value: `${onionAddress.trim()}`,
      description: 'Your private Nostr relay .onion address',
      copyable: true,
      qr: true,
      masked: false,
    },
    // ... more properties
  }
}
```

---

## ğŸš€ ä»Šå¾Œã®å®Ÿè£…è¨ˆç”»

### è¿‘æ—¥å®Ÿè£…äºˆå®š

#### 1. NIP-50 (Search) ã‚µãƒãƒ¼ãƒˆ

**æ¦‚è¦**: Haven ã«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢æ©Ÿèƒ½ã‚’è¿½åŠ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         NIP-50 Search Architecture               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client
  â”‚
  â”‚ REQ ["search", {"search": "bitcoin", ...}]
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search Handler  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FTS Indexâ”‚
    â”‚ (SQLite) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Results  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…äºˆå®š**:
- Full-text search index (SQLite FTS5)
- Private/Chat/Inbox/Outbox å…¨ãƒªãƒ¬ãƒ¼ã§æ¤œç´¢å¯èƒ½
- æ¤œç´¢ã‚¯ã‚¨ãƒª: `{"search": "keyword", "kinds": [1], ...}`

**å„ªå…ˆåº¦**: ğŸ”´ High

#### 2. GUI Dashboard (Start9 LAUNCH UI)

**æ¦‚è¦**: Start9 ã® LAUNCH UI ãƒœã‚¿ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ Web ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

**æ©Ÿèƒ½**:
- ãƒªãƒ¬ãƒ¼çµ±è¨ˆ (ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã€æ¥ç¶šæ•°)
- WoT çµ±è¨ˆ (ãƒ¡ãƒ³ãƒãƒ¼æ•°ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µã‚¤ã‚º)
- Blossom çµ±è¨ˆ (ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡)
- Import å±¥æ­´
- ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼

**å„ªå…ˆåº¦**: ğŸŸ¡ Medium

#### 3. WoT è‡ªå‹•æ›´æ–°

**æ¦‚è¦**: å®šæœŸçš„ã« WoT ã‚’æ›´æ–°

**ç¾çŠ¶**: æ‰‹å‹•ã¾ãŸã¯å†èµ·å‹•æ™‚ã®ã¿  
**å®Ÿè£…äºˆå®š**: è¨­å®šã—ãŸé–“éš”ã§è‡ªå‹•æ›´æ–° (`CHAT_RELAY_WOT_REFRESH_INTERVAL_HOURS`)

**å„ªå…ˆåº¦**: ğŸŸ¢ Low (è¨­å®šã¯æ—¢ã«å­˜åœ¨)

#### 4. Database Migration Tool

**æ¦‚è¦**: LMDB â†” BadgerDB é–“ã®ç§»è¡Œãƒ„ãƒ¼ãƒ«

**å®Ÿè£…äºˆå®š**:
- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«: `./haven --migrate-db lmdb badger`
- Start9 Action ã¨ã—ã¦çµ±åˆ

**å„ªå…ˆåº¦**: ğŸŸ¢ Low

#### 5. Multi-User Support

**æ¦‚è¦**: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Haven ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆ

**å®Ÿè£…äºˆå®š**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è¨­å®š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã® WoT
- å…±æœ‰ Inbox (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

**å„ªå…ˆåº¦**: âšª Future

---

## ğŸ“š å‚è€ƒè³‡æ–™

### Nostr NIPs

- [NIP-01: Basic protocol flow](https://github.com/nostr-protocol/nips/blob/master/01.md)
- [NIP-04: Encrypted Direct Message](https://github.com/nostr-protocol/nips/blob/master/04.md) (Deprecated)
- [NIP-42: Authentication](https://github.com/nostr-protocol/nips/blob/master/42.md)
- [NIP-50: Search Capability](https://github.com/nostr-protocol/nips/blob/master/50.md) (æœªå®Ÿè£…)
- [NIP-59: Gift Wrap](https://github.com/nostr-protocol/nips/blob/master/59.md)
- [NIP-65: Relay List Metadata](https://github.com/nostr-protocol/nips/blob/master/65.md)
- [NIP-96: HTTP File Storage Integration](https://github.com/nostr-protocol/nips/blob/master/96.md)
- [NIP-98: HTTP Auth](https://github.com/nostr-protocol/nips/blob/master/98.md)

### Blossom Specs

- [BUD-01: Blossom Drive Upload](https://github.com/hzrd149/blossom/blob/master/buds/01.md)
- [BUD-02: Blob Descriptor Event](https://github.com/hzrd149/blossom/blob/master/buds/02.md)

### Haven ãƒªãƒã‚¸ãƒˆãƒª

- [Haven Main Repo](https://github.com/bitvora/haven)
- [Haven Start9 Wrapper](https://github.com/bitvora/haven-start9-wrapper)

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [Khatru](https://github.com/fiatjaf/khatru) - Nostr relay framework
- [go-nostr](https://github.com/nbd-wtf/go-nostr) - Nostr client library
- [eventstore](https://github.com/fiatjaf/eventstore) - Database backends

---

## ğŸ“ æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-12-27 | 1.0.0 | åˆç‰ˆä½œæˆ |

---

**Haven** - High Availability Vault for Events on Nostr  
Built with â¤ï¸ by the Nostr community

