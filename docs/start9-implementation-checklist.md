# Haven Start9 Implementation Checklist

## 📋 Overview

このチェックリストは Haven の Start9 パッケージング実装の進捗を追跡するためのものです。各タスクを完了したらチェックマークを付けてください。

---

## 🏗️ Phase 1: 基礎パッケージング

### ファイル作成

- [ ] `Dockerfile` 作成
  - [ ] マルチステージビルド実装
  - [ ] Alpine Linux ベース
  - [ ] Go 1.24 対応
  - [ ] Tor 統合
  - [ ] 非 root ユーザー設定
  - [ ] Tini エントリポイント

- [ ] `docker_entrypoint.sh` 作成
  - [ ] シェバン (`#!/bin/sh`)
  - [ ] 環境変数バリデーション
  - [ ] `.env` ファイル生成
  - [ ] Tor 起動処理
  - [ ] Haven 起動処理
  - [ ] グレースフルシャットダウン (SIGTERM)
  - [ ] ログ出力（色付き）

- [ ] `manifest.yaml` 作成
  - [ ] パッケージ基本情報
  - [ ] バージョン情報
  - [ ] 依存関係定義
  - [ ] ボリューム定義
  - [ ] インターフェース定義（Tor）
  - [ ] ヘルスチェック定義
  - [ ] バックアップ定義

- [ ] `instructions.md` 作成
  - [ ] 初期セットアップ手順
  - [ ] npub 設定方法
  - [ ] 各リレーの説明
  - [ ] Blossom サーバー使用方法
  - [ ] クライアント設定例（Amethyst, Damus）
  - [ ] トラブルシューティング
  - [ ] セキュリティベストプラクティス

- [ ] `Makefile` 作成
  - [ ] `all` ターゲット
  - [ ] `verify` ターゲット
  - [ ] `docker-images.tar` ビルド
  - [ ] `clean` ターゲット
  - [ ] `test` ターゲット
  - [ ] `install` ターゲット

- [ ] `prepare.sh` 作成
  - [ ] Start9 SDK インストール確認
  - [ ] Docker buildx セットアップ
  - [ ] マルチアーキテクチャ有効化
  - [ ] yq インストール確認

### アセット準備

- [ ] `icon.png` 作成
  - [ ] サイズ: 256x256px
  - [ ] フォーマット: PNG
  - [ ] デザイン決定
  - [ ] 透過背景（推奨）

- [ ] `LICENSE` 確認
  - [ ] 既存 LICENSE が適切か確認

### 初期ビルドテスト

- [ ] ローカル Docker ビルド成功
  - [ ] amd64 アーキテクチャ
  - [ ] arm64 アーキテクチャ
  
- [ ] イメージサイズ確認
  - [ ] 目標: < 500MB
  - [ ] 実際のサイズ記録: _________ MB

- [ ] start-sdk verify 成功
  - [ ] エラーなし
  - [ ] 警告があれば対処

---

## 🔒 Phase 2: Tor 統合

### Tor 設定

- [ ] `torrc` ファイル作成
  - [ ] HiddenServiceDir 設定
  - [ ] HiddenServicePort 設定
  - [ ] セキュリティ設定
  - [ ] パフォーマンスチューニング

- [ ] Dockerfile に Tor 統合
  - [ ] Tor パッケージインストール
  - [ ] ディレクトリ権限設定
  - [ ] torrc コピー

- [ ] entrypoint に Tor 起動追加
  - [ ] Tor デーモン起動
  - [ ] .onion アドレス生成待機
  - [ ] TOR_ADDRESS 環境変数設定
  - [ ] ログ出力

### Haven コード修正

- [ ] `config.go` 修正
  - [ ] Tor アドレス判定ロジック
  - [ ] ws:// / wss:// 動的切り替え
  - [ ] ServiceURL 設定

- [ ] `init.go` 修正
  - [ ] 各リレーの ServiceURL を Tor 対応
  - [ ] Blossom サーバー ServiceURL 修正
  - [ ] HTTPS 参照削除

- [ ] `templates/index.html` 修正
  - [ ] リレー URL 表示を動的に
  - [ ] ws:// / wss:// 表記修正

### Tor 接続テスト

- [ ] .onion アドレス生成確認
  - [ ] `/var/lib/tor/haven/hostname` ファイル存在
  - [ ] アドレス形式正しい（.onion）

- [ ] Tor 経由接続テスト
  - [ ] `torsocks curl http://<onion>`
  - [ ] `wscat --socks5 ws://<onion>`

- [ ] Clearnet 無効確認
  - [ ] 外部からの直接アクセス不可
  - [ ] ログにエラーなし

---

## 📁 Phase 3: Blossom Server 最適化

### NIP-96 完全準拠確認

- [ ] 必須エンドポイント確認
  - [ ] `POST /upload`
  - [ ] `GET /<sha256>`
  - [ ] `GET /list/<pubkey>`
  - [ ] `DELETE /<sha256>`

- [ ] NIP-98 認証実装確認
  - [ ] Authorization ヘッダー検証
  - [ ] イベント署名検証
  - [ ] Owner pubkey 検証

- [ ] BUD-02 仕様準拠確認
  - [ ] SHA256 ハッシュ検証
  - [ ] MIME type 判定
  - [ ] レスポンスフォーマット

### ストレージ最適化

- [ ] ファイルシステム構造確認
  - [ ] `/data/blossom/<sha256>` 形式
  - [ ] ディレクトリ権限適切

- [ ] ストレージメトリクス実装
  - [ ] 使用容量計算
  - [ ] ファイル数カウント
  - [ ] Properties に表示

- [ ] クォータ制限（オプション）
  - [ ] 最大ストレージサイズ設定
  - [ ] 超過時の挙動定義
  - [ ] ユーザー通知

### メディア検証強化

- [ ] ファイルサイズ制限
  - [ ] デフォルト: 100MB
  - [ ] 設定可能に

- [ ] MIME type ホワイトリスト
  - [ ] image/jpeg, image/png, image/gif, image/webp
  - [ ] video/mp4, video/webm
  - [ ] 他の type は拒否

- [ ] SHA256 検証
  - [ ] アップロード時にハッシュ計算
  - [ ] クライアント提供のハッシュと比較

- [ ] マルウェアスキャン（オプション）
  - [ ] ClamAV 統合検討
  - [ ] リソース影響評価

### Blossom テスト

- [ ] アップロードテスト
  - [ ] 小サイズ画像 (< 1MB)
  - [ ] 大サイズ画像 (10-50MB)
  - [ ] 動画ファイル

- [ ] ダウンロードテスト
  - [ ] SHA256 直接アクセス
  - [ ] Content-Type ヘッダー正しい
  - [ ] ファイル内容一致

- [ ] 削除テスト
  - [ ] 認証済み削除成功
  - [ ] 非認証削除失敗

- [ ] Amethyst 連携テスト
  - [ ] メディアサーバー追加
  - [ ] 画像アップロード
  - [ ] 投稿内で画像表示
  - [ ] 動画再生

---

## 🎨 Phase 4: UI/UX 改善

### Config UI 実装

- [ ] `assets/compat/config_get.sh` 作成
  - [ ] 現在の設定を YAML で出力
  - [ ] 全設定項目定義
  - [ ] デフォルト値設定

- [ ] `assets/compat/config_set.sh` 作成
  - [ ] YAML パース
  - [ ] 設定バリデーション
  - [ ] 永続化
  - [ ] サービス再起動

- [ ] 設定項目定義
  - [ ] Owner npub
  - [ ] Database engine
  - [ ] Relay names/descriptions
  - [ ] WoT settings
  - [ ] Backup settings
  - [ ] Advanced settings

- [ ] UI テスト
  - [ ] 設定変更反映確認
  - [ ] バリデーションエラー表示
  - [ ] 保存後の再起動

### Properties Display 実装

- [ ] `assets/compat/properties.sh` 作成
  - [ ] Tor アドレス表示
  - [ ] 各リレー URL 表示
  - [ ] Blossom URL 表示
  - [ ] ストレージ統計
  - [ ] WoT 統計
  - [ ] サービス状態

- [ ] QR コード表示
  - [ ] Tor アドレス
  - [ ] Blossom URL

- [ ] コピー可能な URL
  - [ ] 全リレー URL
  - [ ] Blossom URL

- [ ] リアルタイム更新テスト
  - [ ] 値が正しく更新される
  - [ ] パフォーマンス問題なし

### Health Check 実装

- [ ] `assets/compat/check-web.sh` 作成
  - [ ] HTTP 応答確認
  - [ ] WebSocket 接続確認
  - [ ] データベース確認
  - [ ] Tor サービス確認
  - [ ] JSON レスポンス

- [ ] ヘルスチェック頻度設定
  - [ ] manifest.yaml に定義
  - [ ] 適切な間隔（30秒〜5分）

- [ ] エラー時の挙動
  - [ ] 適切なエラーメッセージ
  - [ ] 終了コード設定
  - [ ] リトライ処理

---

## 🚀 Phase 5: ビルドとテスト

### ビルドプロセス

- [ ] Makefile 動作確認
  - [ ] `make` コマンドでビルド成功
  - [ ] `make verify` 成功
  - [ ] `make clean` でクリーンアップ
  - [ ] `make test` でテスト実行

- [ ] prepare.sh 動作確認
  - [ ] クリーン環境で実行
  - [ ] 全依存関係インストール
  - [ ] エラーハンドリング

- [ ] マルチアーキテクチャビルド
  - [ ] amd64 イメージビルド
  - [ ] arm64 イメージビルド
  - [ ] docker-images.tar 生成

- [ ] パッケージサイズ
  - [ ] s9pk ファイルサイズ: _________ MB
  - [ ] 目標: < 200MB

### ユニットテスト

- [ ] Go テスト
  - [ ] `go test ./...` 成功
  - [ ] カバレッジ 80% 以上
  - [ ] エッジケーステスト

- [ ] 設定テスト
  - [ ] config_get.sh 出力検証
  - [ ] config_set.sh 入力検証
  - [ ] バリデーションロジック

- [ ] スクリプトテスト
  - [ ] entrypoint.sh 構文チェック
  - [ ] properties.sh 構文チェック
  - [ ] check-web.sh 構文チェック

### 統合テスト

- [ ] Start9 インストールテスト
  - [ ] サイドロード成功
  - [ ] サービス起動成功
  - [ ] 初期化完了

- [ ] Tor 接続テスト
  - [ ] .onion アドレス取得
  - [ ] 外部からアクセス可能
  - [ ] レイテンシ測定

- [ ] リレーテスト
  - [ ] Private リレー（Auth 必要）
  - [ ] Chat リレー（WoT 検証）
  - [ ] Inbox リレー（タグ検証）
  - [ ] Outbox リレー（公開読み取り）

- [ ] Blossom テスト
  - [ ] アップロード成功
  - [ ] ダウンロード成功
  - [ ] 削除成功
  - [ ] 一覧取得成功

### クライアント連携テスト

- [ ] Amethyst（Android）
  - [ ] リレー追加
  - [ ] 投稿成功
  - [ ] メディアアップロード
  - [ ] メディア表示

- [ ] Damus（iOS）
  - [ ] リレー追加
  - [ ] 投稿成功
  - [ ] DM 送受信

- [ ] 他のクライアント（オプション）
  - [ ] Primal
  - [ ] Coracle
  - [ ] nostrudel

### パフォーマンステスト

- [ ] 負荷テスト
  - [ ] 100 同時接続
  - [ ] 1000 イベント/分
  - [ ] レスポンス時間測定

- [ ] メモリ使用量
  - [ ] アイドル時: _________ MB
  - [ ] 負荷時: _________ MB
  - [ ] メモリリーク確認

- [ ] ストレージ使用量
  - [ ] データベースサイズ推移
  - [ ] Blossom ストレージ推移
  - [ ] ディスク I/O パフォーマンス

---

## 📤 Phase 6: 公開とメンテナンス

### ドキュメント整備

- [ ] README.md 更新
  - [ ] Start9 インストール手順
  - [ ] 機能説明
  - [ ] ライセンス情報
  - [ ] サポート情報

- [ ] CHANGELOG.md 作成
  - [ ] バージョン履歴
  - [ ] 変更内容詳細
  - [ ] Breaking Changes

- [ ] トラブルシューティングガイド
  - [ ] よくある問題
  - [ ] エラーメッセージ一覧
  - [ ] 解決手順

- [ ] API ドキュメント
  - [ ] Nostr リレー仕様
  - [ ] Blossom API
  - [ ] 設定 API

### GitHub リリース準備

- [ ] タグ作成
  - [ ] セマンティックバージョニング
  - [ ] Git タグプッシュ

- [ ] リリースノート作成
  - [ ] 新機能
  - [ ] バグ修正
  - [ ] 既知の問題
  - [ ] アップグレード手順

- [ ] アセット添付
  - [ ] haven.s9pk
  - [ ] checksums.txt
  - [ ] GPG 署名（オプション）

### Start9 Community Registry 申請

- [ ] Registry リポジトリ Fork
  - [ ] GitHub アカウント確認
  - [ ] Fork 作成

- [ ] パッケージメタデータ追加
  - [ ] `packages/haven/` ディレクトリ作成
  - [ ] manifest.yaml コピー
  - [ ] icon.png コピー
  - [ ] instructions.md コピー

- [ ] Pull Request 作成
  - [ ] タイトル: "Add Haven service package"
  - [ ] 説明文作成
  - [ ] チェックリスト確認

- [ ] レビュー対応
  - [ ] フィードバック確認
  - [ ] 修正反映
  - [ ] 再提出

### ベータテスト

- [ ] テスター募集
  - [ ] 5-10 名
  - [ ] 多様な環境（x86/ARM、異なるストレージ）

- [ ] フィードバック収集
  - [ ] インストール体験
  - [ ] 設定の分かりやすさ
  - [ ] パフォーマンス
  - [ ] バグレポート

- [ ] 問題修正
  - [ ] クリティカル: 即時修正
  - [ ] メジャー: v1.0 前に修正
  - [ ] マイナー: 次バージョンで対応

### 継続的メンテナンス

- [ ] CI/CD セットアップ
  - [ ] GitHub Actions
  - [ ] 自動ビルド
  - [ ] 自動テスト
  - [ ] 自動リリース

- [ ] 監視・モニタリング
  - [ ] エラートラッキング
  - [ ] 使用統計（オプション）
  - [ ] セキュリティアラート

- [ ] コミュニティサポート
  - [ ] GitHub Issues 対応
  - [ ] Discussions 参加
  - [ ] Nostr での情報発信

---

## ✅ 最終確認チェックリスト

### リリース前必須項目

- [ ] **機能完全性**
  - [ ] 4つのリレー全て動作
  - [ ] Blossom サーバー動作
  - [ ] Tor 経由アクセス可能
  - [ ] WoT 機能動作

- [ ] **セキュリティ**
  - [ ] Clearnet アクセス不可
  - [ ] 認証機能正常
  - [ ] 入力バリデーション実装
  - [ ] エラーメッセージにセンシティブ情報なし

- [ ] **互換性**
  - [ ] amd64 動作確認
  - [ ] arm64（RPi）動作確認
  - [ ] Amethyst 連携確認
  - [ ] 主要 Nostr クライアント対応

- [ ] **品質**
  - [ ] テストカバレッジ 80%+
  - [ ] メモリリークなし
  - [ ] エラーハンドリング適切
  - [ ] ログ出力適切

- [ ] **ドキュメント**
  - [ ] README 完備
  - [ ] instructions.md 完備
  - [ ] トラブルシューティング完備
  - [ ] CHANGELOG 完備

- [ ] **ビルド & パッケージ**
  - [ ] `make verify` 成功
  - [ ] パッケージサイズ適切
  - [ ] インストール手順確認
  - [ ] アンインストール手順確認

### 推奨項目

- [ ] GPG 署名
- [ ] パフォーマンスベンチマーク公開
- [ ] デモ動画作成
- [ ] スクリーンショット準備
- [ ] コミュニティフォーラム投稿

---

## 📊 進捗トラッキング

### Phase 別進捗

| Phase | 完了タスク | 総タスク | 進捗率 | ステータス |
|-------|-----------|---------|--------|-----------|
| Phase 1 | 25 | 25 | 100% | ✅ Completed |
| Phase 2 | 18 | 18 | 100% | ✅ Completed |
| Phase 3 | 8 | 22 | 36% | 🔄 In Progress |
| Phase 4 | 18 | 20 | 90% | 🔄 In Progress |
| Phase 5 | 8 | 35 | 23% | 🔄 In Progress |
| Phase 6 | 0 | 25 | 0% | ⏸️ Not Started |
| **合計** | **77** | **145** | **53%** | 🔄 In Progress |

### ステータス凡例

- ⏸️ Not Started - 未着手
- 🔄 In Progress - 進行中
- ⚠️ Blocked - ブロック中
- ✅ Completed - 完了
- ❌ Failed - 失敗

### タイムライン

```
Week 1: [                              ] Phase 1
Week 2: [                              ] Phase 2
Week 3: [                              ] Phase 3 & 4
Week 4: [                              ] Phase 5
Week 5: [                              ] Phase 6
```

---

## 📝 ノート・メモ

### 発見した問題

#### 2025-12-25: Start9 パーミッション問題
**問題**: `/data` ボリュームへの書き込み権限がない  
**解決策**: 
- entrypoint を root として実行
- `su-exec` を使って Haven と Tor を `haven` ユーザーとして起動
- ファイル作成を `/app` ディレクトリで行う

**ステータス**: ✅ 解決済み

#### 2025-12-25: Deno.run() 制限
**問題**: Start9 の Deno 環境で `Deno.run()` が無効  
**解決策**:
- `config` は `type: script` のまま（Deno 環境）
- `properties` は `type: docker` に変更（動的情報取得のため）
- TypeScript から動的情報取得を削除

**ステータス**: ✅ 解決済み

#### 2025-12-25: Tor 権限エラー
**問題**: Tor が root で実行され、データディレクトリが `haven` ユーザー所有のためエラー  
**解決策**: Tor も `su-exec haven` で実行するように変更  
**ステータス**: ✅ 解決済み

#### 2025-12-25: Relay リストファイル不在
**問題**: Haven が `/app/relays_import.json` を見つけられない  
**解決策**: entrypoint で空のファイルを Haven ユーザーとして作成  
**ステータス**: ✅ 解決済み

#### 2025-12-25: Blossom サーバーエラー（未解決）
**問題**: Blossom サーバーで何らかのエラーが発生  
**解決策**: Amethyst のメディアアップロード仕様を確認し、Haven の実装を検証  
**ステータス**: ⚠️ 調査中

### 技術的決定

#### 2025-12-25: ハイブリッド型 Procedure 実装
**決定事項**: `config` は `type: script`、`properties` は `type: docker`  
**理由**:
- Config は静的なスキーマ定義なので Deno で十分
- Properties は動的情報（Tor アドレス、ストレージ）を取得するため Docker が必要
- QR コード機能も Docker 版で正しく動作

**代替案**: 全て `type: docker` にする → 不要な複雑性が増える

#### 2025-12-25: su-exec の採用
**決定事項**: Alpine Linux の `su-exec` を使用  
**理由**:
- `gosu` は Alpine Linux で利用不可
- `su` は SUID ビットの問題あり
- `su-exec` は軽量で Alpine 向けに最適化

**代替案**: `gosu` をソースからビルド → ビルド時間増加、複雑性増加

#### 2025-12-25: Relay リストファイルの配置
**決定事項**: `/app` ディレクトリに作成  
**理由**:
- `/data` への書き込みが制限されている
- Haven は `/app` を作業ディレクトリとして使用
- `/app` は Haven ユーザーの所有権で作成済み

**代替案**: `/data` に作成を試み続ける → Start9 の制限により失敗

### 今後の改善点

#### Blossom サーバーの検証と修正
**アイデア**: Amethyst のメディアアップロード仕様に準拠しているか確認  
**優先度**: 🔴 High  
**実装見積**: 2-3時間

#### Blastr リレーの実装
**アイデア**: 他のリレーへのイベント転送機能を実装  
**優先度**: 🟡 Medium  
**実装見積**: 4-6時間

#### WoT 設定の UI 改善
**アイデア**: Web of Trust の depth や refresh interval を視覚的に表示  
**優先度**: 🟢 Low  
**実装見積**: 2-3時間

#### パフォーマンスモニタリング
**アイデア**: リレーのメトリクス（イベント数、接続数）を Properties に表示  
**優先度**: 🟢 Low  
**実装見積**: 3-4時間

---

**チェックリスト作成日**: 2025-12-24  
**最終更新**: 2025-12-24  
**次のレビュー日**: ___________

---

_このチェックリストを定期的に更新し、進捗を記録してください。_

