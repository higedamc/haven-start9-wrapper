# Haven Start9 Bug & Issue Checklist

## 📅 作成日: 2025-12-25
## 🎯 目的: Haven の既知の問題と今後の修正計画を追跡

---

## 🔴 Critical Issues（即座に修正が必要）

### 1. Tor アドレスが永続化されない問題

**優先度**: 🔴 Critical  
**発見日**: 2025-12-25  
**ステータス**: ✅ 解決済み（v1.0.8）

**症状**:
- パッケージをサイドローディング（更新）すると、Tor の .onion アドレスが変わってしまう
- ユーザーはリレー URL を再設定する必要がある
- 既存のフォロワーがリレーにアクセスできなくなる

**根本原因**:
- Tor の `HiddenServiceDir` が `/var/lib/tor/haven/` に設定されていた
- このディレクトリは永続化ボリューム `/data` にマウントされていない
- コンテナの再作成時に Tor の秘密鍵が失われ、新しい .onion アドレスが生成される

**実施した修正**:
- ✅ `torrc`: `HiddenServiceDir` を `/data/tor/haven/` に変更
- ✅ `Dockerfile`: `/data/tor` ディレクトリを作成、適切なパーミッション設定
- ✅ `docker_entrypoint.sh`: `/data/tor/haven` の作成と既存アドレスの検出ロジックを追加
- ✅ `manifest.yaml`: v1.0.8 としてリリース

**修正内容詳細**:
```bash
# Before: 永続化されない
HiddenServiceDir /var/lib/tor/haven/

# After: /data にマウントされて永続化
HiddenServiceDir /data/tor/haven/
```

**期待される成果**:
- ✅ パッケージ更新時に .onion アドレスが変わらない
- ✅ コンテナの再起動時も同じアドレスを使用
- ✅ ユーザーは一度設定すれば、その後の更新で再設定不要

**担当**: AI Assistant  
**完了日**: 2025-12-25

---

### 2. Blossom サーバーのエラー

**優先度**: 🔴 Critical  
**発見日**: 2025-12-25  
**ステータス**: ✅ 解決済み（v1.0.7）

**症状**:
- Haven が起動し、Tor アドレスも生成されるが、ログの最後に Blossom サーバー関連のエラーが表示される
- ログ内容: （具体的なエラーメッセージを追加予定）

**発見された問題**:
1. ✅ **ファイルパスの問題**: `config.BlossomPath + sha256` により、`blossom<sha256>` となり正しいディレクトリパスにならない
2. ✅ **URL スキームの問題**: Tor .onion アドレスに `https://` を使用していたが、`http://` を使うべき
3. ⚠️ **エラーログ不足**: デバッグが困難

**実施した修正**:
- ✅ `haven/init.go`: Blossom ファイルパスを `config.BlossomPath + "/" + sha256` に修正
- ✅ `haven/config.go`: `BlossomPath` の末尾スラッシュを削除する処理を追加
- ✅ `haven/init.go`: ファイル操作（作成、読み込み、削除）に詳細なエラーログを追加
- ✅ `haven/init.go`: すべてのリレーの `ServiceURL` を `https://` から `http://` に変更
- ✅ `haven/blossomMigration.go`: Blossom マイグレーションの `ServiceURL` を `http://` に変更
- ✅ `haven/init.go`: Blossom サーバー初期化時のログを追加

**修正内容詳細**:
```go
// Before:
file, err := fs.Create(config.BlossomPath + sha256)

// After:
file, err := fs.Create(config.BlossomPath + "/" + sha256)
if err != nil {
    slog.Error("🚫 Failed to create blob file", "error", err, "path", config.BlossomPath+"/"+sha256)
    return err
}
```

```go
// Before:
bl := blossom.New(outboxRelay, "https://"+config.RelayURL)

// After:
// Use http:// for Tor .onion addresses as they are already encrypted
serviceURL := "http://" + config.RelayURL
slog.Info("🌸 Initializing Blossom server", "serviceURL", serviceURL, "storagePath", config.BlossomPath)
bl := blossom.New(outboxRelay, serviceURL)
```

**次のステップ**:
- [ ] Docker ビルドしてテスト
- [ ] Amethyst でメディアアップロードをテスト
- [ ] ログを確認して追加の問題がないか確認
- [ ] NIP-98 認証が正しく機能しているか確認

**期待される成果**:
- Amethyst から Haven の Blossom サーバーにメディアをアップロードできる
- アップロードしたメディアが Nostr 投稿内で正しく表示される

**担当**: AI Assistant  
**期限**: 2025-12-26

---

## 🟡 High Priority Issues（早急に修正すべき）

### 3. Blastr リレーの未実装

**優先度**: 🟡 High  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- `relays_blastr.json` ファイルは作成されるが、Blastr リレー機能自体が実装されていない
- 他のリレーへのイベント転送が行われない

**想定される原因**:
- Haven の Blastr 機能が未実装または無効化されている
- 設定ファイルで Blastr が有効になっていない

**調査手順**:
- [ ] Haven のソースコードで Blastr 実装を確認
- [ ] `config.go` で Blastr 設定を確認
- [ ] `relays_blastr.json` の読み込みロジックを確認

**解決策候補**:
1. Haven の Blastr 機能を有効化
2. Start9 の設定で Blastr リレーリストを設定可能にする
3. デフォルトの Blastr リレーリストを提供

**期待される成果**:
- Haven に投稿されたイベントが、設定された外部リレーに自動転送される
- Blastr リレーリストを Start9 UI から設定できる

**担当**: TBD  
**期限**: 2026-01-10

---

### 4. Properties の動的更新

**優先度**: 🟡 High  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- Properties（データベースサイズ、メディアストレージ）の値が静的
- サービス起動後に値が更新されない可能性

**想定される原因**:
- `properties.sh` がキャッシュされている
- Start9 が Properties を定期的に再実行していない

**調査手順**:
- [ ] Start9 の Properties 更新頻度を確認
- [ ] `properties.sh` の実行ログを確認
- [ ] `manifest.yaml` の Properties 設定を確認

**解決策候補**:
1. Start9 の Properties 更新頻度を manifest で明示的に設定
2. Properties にタイムスタンプを追加
3. リアルタイム更新を諦め、手動更新ボタンを追加（Start9 の機能次第）

**期待される成果**:
- データベースサイズとメディアストレージが常に最新の値を表示する

**担当**: TBD  
**期限**: 2026-01-15

---

## 🟢 Medium Priority Issues（改善すべき）

### 5. Config UI の改善

**優先度**: 🟢 Medium  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- 設定項目が多すぎて、UI が複雑
- デフォルト値が適切かどうか不明瞭

**解決策候補**:
1. 設定項目を「基本設定」「高度な設定」に分ける
2. 各設定項目にツールチップや詳細説明を追加
3. デフォルト値を推奨値として明示

**期待される成果**:
- 初心者でも簡単に Haven を設定できる
- 高度な設定は必要に応じて変更可能

**担当**: TBD  
**期限**: 2026-01-20

---

### 6. Health Check の詳細化

**優先度**: 🟢 Medium  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- Health Check が単純な HTTP チェックのみ
- WebSocket 接続や Tor 接続の健全性を確認していない

**解決策候補**:
1. `check-web.sh` を拡張し、以下を確認:
   - WebSocket 接続が可能か
   - Tor サービスが起動しているか
   - データベースにアクセス可能か
   - メモリ使用量が上限を超えていないか

**期待される成果**:
- より詳細なヘルスチェックにより、問題を早期発見できる

**担当**: TBD  
**期限**: 2026-02-01

---

### 7. エラーメッセージの改善

**優先度**: 🟢 Medium  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- エラーメッセージが技術的すぎて、ユーザーに理解しづらい
- 解決策が提示されていない

**解決策候補**:
1. エラーメッセージを平易な日本語（または英語）に翻訳
2. 各エラーメッセージに解決策を提示
3. トラブルシューティングガイドへのリンクを追加

**期待される成果**:
- ユーザーが自力でトラブルシューティングできる

**担当**: TBD  
**期限**: 2026-02-10

---

## 🔵 Low Priority Issues（余裕があれば修正）

### 8. パフォーマンスメトリクスの表示

**優先度**: 🔵 Low  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- リレーのパフォーマンス（イベント数、接続数）が不明
- ボトルネックを特定できない

**解決策候補**:
1. Properties にリレーメトリクスを追加:
   - アクティブな WebSocket 接続数
   - 処理したイベント数（24時間）
   - 平均レスポンス時間
   - メモリ使用量

**期待される成果**:
- リレーのパフォーマンスを可視化し、最適化の指標とする

**担当**: TBD  
**期限**: 2026-03-01

---

### 9. バックアップ機能の実装

**優先度**: 🔵 Low  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- Start9 の標準バックアップ機能のみで、Haven 専用のバックアップ機能がない
- クラウドバックアップ（S3, Backblaze）が未実装

**解決策候補**:
1. `manifest.yaml` でバックアップ対象を明示的に定義
2. クラウドバックアップ機能を実装（config で有効化）
3. バックアップのスケジュール設定を追加

**期待される成果**:
- ユーザーのデータが安全に保護される
- クラウドバックアップでリモートリストアが可能

**担当**: TBD  
**期限**: 2026-04-01

---

### 10. マルチリレー対応の改善

**優先度**: 🔵 Low  
**発見日**: 2025-12-25  
**ステータス**: ⏸️ 未着手

**症状**:
- 現在は 4 つのリレー（Private, Chat, Inbox, Outbox）が固定
- ユーザーが独自のリレーを追加できない

**解決策候補**:
1. Config で追加リレーを定義可能にする
2. 各リレーに独自の設定（WoT depth, フィルター）を適用可能にする

**期待される成果**:
- ユーザーが柔軟にリレーをカスタマイズできる

**担当**: TBD  
**期限**: 2026-05-01

---

## 📊 テストチェックリスト

### Blossom サーバーテスト（修正後）

- [ ] **アップロードテスト**
  - [ ] 小サイズ画像 (< 1MB) をアップロード
  - [ ] 大サイズ画像 (10-50MB) をアップロード
  - [ ] 動画ファイル (MP4, WebM) をアップロード
  - [ ] NIP-98 認証ヘッダーが正しく検証される

- [ ] **ダウンロードテスト**
  - [ ] SHA256 ハッシュで直接アクセス可能
  - [ ] `Content-Type` ヘッダーが正しい
  - [ ] ファイル内容が元のファイルと一致

- [ ] **削除テスト**
  - [ ] 認証済みユーザーが自分のファイルを削除可能
  - [ ] 非認証ユーザーは削除できない

- [ ] **Amethyst 連携テスト**
  - [ ] Amethyst でメディアサーバーとして Haven を追加
  - [ ] 画像をアップロードして投稿
  - [ ] 投稿内で画像が正しく表示される
  - [ ] 動画をアップロードして再生

### Blastr リレーテスト（修正後）

- [ ] Blastr リレーリストを設定
- [ ] Haven に投稿したイベントが外部リレーに転送される
- [ ] 転送失敗時のエラーハンドリング

### Properties 更新テスト

- [ ] サービス起動直後の Properties を確認
- [ ] 10 分後に Properties を再確認し、値が更新されているか
- [ ] ファイルをアップロードして、メディアストレージの値が増加するか

---

## 🗓️ リリース計画

### v1.0.8（Critical Hotfix）- 2025-12-25 ✅ 完了

**目標**: Tor アドレス永続化とBlossom サーバー修正

- [x] Tor アドレス永続化の問題修正
- [x] Blossom サーバーのエラー修正
- [ ] Amethyst との連携テスト
- [ ] リリース

### v1.0.7（Hotfix）- 2025-12-25 ✅ 完了

**目標**: Blossom サーバーを動作させる

- [x] Blossom サーバーのエラー修正
- [ ] Amethyst との連携テスト

### v1.1.0（Feature）- 2026-01-15

**目標**: Blastr と Properties 改善

- [ ] Blastr リレー実装
- [ ] Properties の動的更新
- [ ] Config UI の改善

### v1.2.0（Enhancement）- 2026-02-15

**目標**: 監視とエラーハンドリング強化

- [ ] Health Check の詳細化
- [ ] エラーメッセージの改善
- [ ] パフォーマンスメトリクスの表示

### v2.0.0（Major）- 2026-06-01

**目標**: クラウドバックアップとカスタマイズ性向上

- [ ] バックアップ機能の実装
- [ ] マルチリレー対応の改善
- [ ] 大規模リファクタリング

---

## 📝 ノート

### 優先順位の決定基準

- **🔴 Critical**: サービスが正常に動作しない、ユーザーに重大な影響
- **🟡 High**: 主要機能が未実装または不完全
- **🟢 Medium**: UX や保守性の改善
- **🔵 Low**: Nice to have、将来的な拡張

### バグ報告テンプレート

新しいバグを発見した場合は、以下の形式で追加してください：

```markdown
### X. [バグタイトル]

**優先度**: 🔴/🟡/🟢/🔵  
**発見日**: YYYY-MM-DD  
**ステータス**: ⚠️ 調査中 / ⏸️ 未着手 / 🔄 修正中 / ✅ 解決済み

**症状**:
（具体的な現象を記載）

**想定される原因**:
（技術的な原因の仮説を列挙）

**調査手順**:
- [ ] 調査項目 1
- [ ] 調査項目 2

**解決策候補**:
（考えられる解決方法を列挙）

**期待される成果**:
（修正後の理想的な状態）

**担当**: TBD  
**期限**: YYYY-MM-DD
```

---

**作成日**: 2025-12-25  
**最終更新**: 2025-12-25  
**次回レビュー**: 2025-12-26


