# Haven Start9 Server ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°å®Ÿè£…è¨ˆç”»

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

Haven (High Availability Vault for Events on Nostr) ã‚’ Start9 Server ç”¨ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã€Tor-onlyç’°å¢ƒã§å‹•ä½œã™ã‚‹ self-sovereign ãª Nostr ãƒªãƒ¬ãƒ¼ + Blossom ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å±•é–‹ã™ã‚‹ã€‚

### ä¸»è¦ç›®æ¨™

1. **Start9 Server ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–**: `s9pk` å½¢å¼ã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
2. **Tor-Only å¯¾å¿œ**: Clearnet ã‚’ç„¡åŠ¹åŒ–ã—ã€Tor Hidden Service ã¨ã—ã¦å‹•ä½œ
3. **Blossom Server çµ±åˆ**: Amethyst ãªã©ã® Nostr ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§åˆ©ç”¨å¯èƒ½ãªãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### Haven ã®ç¾åœ¨ã®æ§‹æˆ

```
Haven Application
â”œâ”€â”€ Private Relay    (Auth required, owner only)
â”œâ”€â”€ Chat Relay       (WoT protected DMs)
â”œâ”€â”€ Inbox Relay      (WoT protected, owner tagged events)
â”œâ”€â”€ Outbox Relay     (Public readable, owner writable)
â””â”€â”€ Blossom Server   (Media storage, BUD-02 compliant)
```

### Start9 çµ±åˆå¾Œã®æ§‹æˆ

```
Start9 Server Environment
â”œâ”€â”€ Tor Hidden Service Layer
â”‚   â””â”€â”€ .onion address generation
â”œâ”€â”€ Haven Container
â”‚   â”œâ”€â”€ Go Application (Port 3355)
â”‚   â”œâ”€â”€ Database (BadgerDB/LMDB)
â”‚   â”œâ”€â”€ Blossom Storage (Filesystem)
â”‚   â””â”€â”€ Configuration Management
â””â”€â”€ Persistent Storage
    â”œâ”€â”€ /data/db/         (Relay databases)
    â”œâ”€â”€ /data/blossom/    (Media files)
    â””â”€â”€ /data/backups/    (Optional cloud backups)
```

---

## ğŸ“¦ Start9 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆè¦ç´ 

### å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«å | ç›®çš„ | å„ªå…ˆåº¦ |
|----------|------|--------|
| `Dockerfile` | ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ | ğŸ”´ å¿…é ˆ |
| `manifest.yaml` | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ | ğŸ”´ å¿…é ˆ |
| `instructions.md` | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜æ›¸ | ğŸ”´ å¿…é ˆ |
| `icon.png` | UIã‚¢ã‚¤ã‚³ãƒ³ (256x256pxæ¨å¥¨) | ğŸ”´ å¿…é ˆ |
| `LICENSE` | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ (æ—¢å­˜) | ğŸ”´ å¿…é ˆ |
| `Makefile` | ãƒ“ãƒ«ãƒ‰è‡ªå‹•åŒ– | ğŸ”´ å¿…é ˆ |
| `prepare.sh` | ãƒ“ãƒ«ãƒ‰ç’°å¢ƒæº–å‚™ | ğŸ”´ å¿…é ˆ |
| `docker_entrypoint.sh` | ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ğŸ”´ å¿…é ˆ |
| `assets/compat/config.yaml` | è¨­å®šã‚¹ã‚­ãƒ¼ãƒ | ğŸŸ¡ æ¨å¥¨ |
| `assets/compat/properties.yaml` | å‹•çš„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¡¨ç¤º | ğŸŸ¡ æ¨å¥¨ |

---

## ğŸ¯ Phase 1: åŸºç¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚° (Week 1)

### 1.1 Dockerfile ä½œæˆ

**ç›®çš„**: ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰

```dockerfile
# Multi-stage build for optimized image size
FROM golang:1.24-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    git \
    build-base \
    openssl

WORKDIR /build

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build for both amd64 and arm64
ARG TARGETARCH
RUN CGO_ENABLED=1 GOOS=linux GOARCH=${TARGETARCH} \
    go build -ldflags="-s -w" -o haven .

# Runtime stage
FROM alpine:latest

# Install runtime dependencies
RUN apk add --no-cache \
    ca-certificates \
    tor \
    tini

# Create non-root user
RUN adduser -D -u 1000 haven

# Create necessary directories
RUN mkdir -p /data/db /data/blossom /data/backups && \
    chown -R haven:haven /data

WORKDIR /app

# Copy binary from builder
COPY --from=builder /build/haven .
COPY --from=builder /build/templates ./templates

# Copy entrypoint script
COPY docker_entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker_entrypoint.sh

USER haven

EXPOSE 3355

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["/usr/local/bin/docker_entrypoint.sh"]
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] Dockerfile ä½œæˆ
- [ ] ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (amd64/arm64)
- [ ] ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºæœ€é©åŒ– (ç›®æ¨™: <500MB)

---

### 1.2 docker_entrypoint.sh ä½œæˆ

**ç›®çš„**: ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã®åˆæœŸåŒ–ã¨ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³

```bash
#!/bin/sh
set -e

# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo "${RED}[ERROR]${NC} $1"
}

# Trap SIGTERM for graceful shutdown
trap 'log_info "Received SIGTERM, shutting down gracefully..."; kill -TERM $PID; wait $PID' TERM

# Generate .env file from Start9 environment variables
generate_env_file() {
    log_info "Generating configuration from Start9 environment..."
    
    cat > /app/.env <<EOF
# Haven Configuration (Generated by Start9)
OWNER_NPUB=${OWNER_NPUB}
DB_ENGINE=${DB_ENGINE:-badger}
LMDB_MAPSIZE=${LMDB_MAPSIZE:-}
BLOSSOM_PATH=/data/blossom/
RELAY_URL=${TOR_ADDRESS}
RELAY_PORT=3355
RELAY_BIND_ADDRESS=0.0.0.0

# Private Relay
PRIVATE_RELAY_NAME=${PRIVATE_RELAY_NAME:-Haven Private}
PRIVATE_RELAY_NPUB=${OWNER_NPUB}
PRIVATE_RELAY_DESCRIPTION=${PRIVATE_RELAY_DESCRIPTION:-My private relay}
PRIVATE_RELAY_ICON=${PRIVATE_RELAY_ICON:-}

# Chat Relay
CHAT_RELAY_NAME=${CHAT_RELAY_NAME:-Haven Chat}
CHAT_RELAY_NPUB=${OWNER_NPUB}
CHAT_RELAY_DESCRIPTION=${CHAT_RELAY_DESCRIPTION:-My chat relay}
CHAT_RELAY_ICON=${CHAT_RELAY_ICON:-}
CHAT_RELAY_WOT_DEPTH=${CHAT_RELAY_WOT_DEPTH:-2}
CHAT_RELAY_WOT_REFRESH_INTERVAL_HOURS=${CHAT_RELAY_WOT_REFRESH_INTERVAL_HOURS:-24}
CHAT_RELAY_MINIMUM_FOLLOWERS=${CHAT_RELAY_MINIMUM_FOLLOWERS:-10}

# Outbox Relay
OUTBOX_RELAY_NAME=${OUTBOX_RELAY_NAME:-Haven Outbox}
OUTBOX_RELAY_NPUB=${OWNER_NPUB}
OUTBOX_RELAY_DESCRIPTION=${OUTBOX_RELAY_DESCRIPTION:-My outbox relay}
OUTBOX_RELAY_ICON=${OUTBOX_RELAY_ICON:-}

# Inbox Relay
INBOX_RELAY_NAME=${INBOX_RELAY_NAME:-Haven Inbox}
INBOX_RELAY_NPUB=${OWNER_NPUB}
INBOX_RELAY_DESCRIPTION=${INBOX_RELAY_DESCRIPTION:-My inbox relay}
INBOX_RELAY_ICON=${INBOX_RELAY_ICON:-}
INBOX_PULL_INTERVAL_SECONDS=${INBOX_PULL_INTERVAL_SECONDS:-3600}

# Import Settings
IMPORT_START_DATE=${IMPORT_START_DATE:-}
IMPORT_OWNER_NOTES_FETCH_TIMEOUT_SECONDS=30
IMPORT_TAGGED_NOTES_FETCH_TIMEOUT_SECONDS=120
IMPORT_QUERY_INTERVAL_SECONDS=360000
IMPORT_SEED_RELAYS_FILE=/app/relays_import.json
BLASTR_RELAYS_FILE=/app/relays_blastr.json

# Backup Settings
BACKUP_PROVIDER=${BACKUP_PROVIDER:-none}
BACKUP_INTERVAL_HOURS=${BACKUP_INTERVAL_HOURS:-24}

# Advanced Settings
WOT_FETCH_TIMEOUT_SECONDS=30
HAVEN_LOG_LEVEL=${LOG_LEVEL:-INFO}
EOF

    log_info "Configuration file generated successfully"
}

# Validate required environment variables
validate_config() {
    log_info "Validating configuration..."
    
    if [ -z "$OWNER_NPUB" ]; then
        log_error "OWNER_NPUB is not set"
        exit 1
    fi
    
    if [ -z "$TOR_ADDRESS" ]; then
        log_error "TOR_ADDRESS is not set"
        exit 1
    fi
    
    log_info "Configuration validated successfully"
}

# Initialize relay lists if not exist
initialize_relay_lists() {
    if [ ! -f /app/relays_import.json ]; then
        log_info "Creating default import relay list..."
        echo '[]' > /app/relays_import.json
    fi
    
    if [ ! -f /app/relays_blastr.json ]; then
        log_info "Creating default blastr relay list..."
        echo '[]' > /app/relays_blastr.json
    fi
}

# Main execution
main() {
    log_info "Starting Haven for Start9..."
    
    validate_config
    generate_env_file
    initialize_relay_lists
    
    # Check if this is an import run
    if [ "$RUN_IMPORT" = "true" ]; then
        log_info "Running import mode..."
        /app/haven --import
        exit 0
    fi
    
    log_info "Starting Haven relay server..."
    /app/haven &
    PID=$!
    
    wait $PID
    EXIT_CODE=$?
    
    log_info "Haven stopped with exit code: $EXIT_CODE"
    exit $EXIT_CODE
}

main
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] entrypoint ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] ç’°å¢ƒå¤‰æ•°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ†ã‚¹ãƒˆ

---

### 1.3 manifest.yaml ä½œæˆ

**ç›®çš„**: Start9 ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šå®šç¾©

```yaml
id: haven
title: Haven
version: 1.0.6
release-notes: |
  - Initial Start9 release
  - Tor-only operation
  - Full Blossom server support
  - Web of Trust integration
license: MIT
wrapper-repo: https://github.com/bitvora/haven-start9-wrapper
upstream-repo: https://github.com/bitvora/haven
support-site: https://github.com/bitvora/haven/issues
marketing-site: https://github.com/bitvora/haven
donation-url: null

description:
  short: Self-sovereign Nostr relay suite with Blossom media server
  long: |
    Haven (High Availability Vault for Events on Nostr) is a comprehensive 
    personal Nostr relay implementation featuring four specialized relays 
    and an integrated Blossom media server. Run your own sovereign 
    communications infrastructure over Tor.
    
    Features:
    - Private Relay: Your personal secure storage
    - Chat Relay: Web of Trust protected direct messages
    - Inbox Relay: Receive tagged events from trusted sources
    - Outbox Relay: Public broadcast of your events
    - Blossom Server: Decentralized media hosting (NIP-96 & BUD-02 compliant)

assets:
  - LICENSE
  - icon.png
  - instructions.md
  - docker-images.tar

main:
  type: docker
  image: main
  entrypoint: docker_entrypoint.sh
  args: []
  mounts:
    main: /data
  gpu-acceleration: false
  shm-size-mb: null

health-checks:
  main:
    name: Web Interface
    success-message: Haven is running and accessible
    type: docker
    image: main
    entrypoint: check-web.sh
    args: []
    io-format: json
    inject: true

config:
  get:
    type: script
  set:
    type: script

properties:
  type: script

volumes:
  main:
    type: data

interfaces:
  main:
    name: Nostr Relay Interface
    description: Main Nostr relay endpoint (WebSocket)
    tor-config:
      port-mapping:
        3355: 80
    lan-config: null
    ui: true
    protocols:
      - tcp
      - http
      - ws

dependencies: {}

backup:
  create:
    type: docker
    image: compat
    system: true
    entrypoint: compat
    args:
      - duplicity
      - create
      - /mnt/backup
      - /data
    mounts:
      BACKUP: /mnt/backup
      main: /data
  restore:
    type: docker
    image: compat
    system: true
    entrypoint: compat
    args:
      - duplicity
      - restore
      - /mnt/backup
      - /data
    mounts:
      BACKUP: /mnt/backup
      main: /data

migrations:
  from: {}
  to: {}
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] manifest.yaml ä½œæˆ
- [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ–¹é‡æ±ºå®š
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…

---

### 1.4 instructions.md ä½œæˆ

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

```markdown
# Haven Setup Instructions

## Initial Configuration

After installation, you'll need to configure Haven with your Nostr public key (npub).

### Step 1: Get Your Nostr Public Key

If you don't have a Nostr identity yet:
1. Install a Nostr client (e.g., Amethyst, Damus, Primal)
2. Create a new account
3. Copy your public key (npub1...)

### Step 2: Configure Haven

1. Go to Haven's Config page
2. Enter your Nostr public key (npub1...)
3. Customize relay names and descriptions (optional)
4. Save configuration

### Step 3: Access Your Relays

Haven provides four specialized relays, all accessible via Tor:

#### Outbox Relay (Public)
- URL: `ws://your-haven-address.onion`
- Purpose: Your public posts
- Anyone can read, only you can write

#### Private Relay
- URL: `ws://your-haven-address.onion/private`
- Purpose: Private drafts, eCash notes
- Only you can read and write (Auth required)

#### Chat Relay
- URL: `ws://your-haven-address.onion/chat`
- Purpose: Direct messages
- Web of Trust protected (Auth required)

#### Inbox Relay
- URL: `ws://your-haven-address.onion/inbox`
- Purpose: Receive replies and mentions
- Web of Trust protected

### Step 4: Configure Nostr Clients

Add your Haven relays to your Nostr client:

**Amethyst (Android)**:
1. Settings â†’ Relays
2. Add relay URLs from above
3. Set permissions accordingly

**Damus (iOS)**:
1. Settings â†’ Relays
2. Add custom relay
3. Enter your .onion addresses

## Blossom Media Server

Haven includes a Blossom-compliant media server for hosting images and videos.

### Blossom Server URL
`https://your-haven-address.onion`

### Supported Clients
- Amethyst (built-in support)
- Coracle
- nostrudel

### Upload Media
1. In Amethyst: Settings â†’ Media Servers
2. Add your Haven .onion address
3. Upload media directly from the client

## Web of Trust

Haven uses Web of Trust (WoT) to protect your Chat and Inbox relays from spam.

### How It Works
- Haven automatically fetches your follow list
- Follows up to specified depth (default: 2)
- Updates periodically (default: 24 hours)

### Configure WoT Settings
1. Go to Config page
2. Adjust WoT depth (1-3 recommended)
3. Set refresh interval
4. Set minimum followers threshold

## Advanced Features

### Import Old Notes
To import your existing notes from other relays:
1. Go to Config page
2. Add seed relay URLs
3. Set import start date
4. Save and restart
5. Haven will import in background

### Cloud Backups
Haven supports automated cloud backups to S3-compatible services:
1. Go to Config â†’ Backup Settings
2. Choose backup provider (DigitalOcean Spaces, AWS S3, etc.)
3. Enter credentials
4. Set backup interval
5. Enable backups

### Database Selection
Haven supports two database engines:
- **BadgerDB** (default): Better compatibility, easier setup
- **LMDB**: Higher performance on NVMe drives

Change in Config â†’ Advanced Settings if needed.

## Troubleshooting

### Can't Connect to Relay
- Verify Tor is working on Start9
- Check Haven service status
- Ensure .onion address is correct

### Authentication Failures
- Verify npub is correct
- Ensure your Nostr client supports NIP-42 (Auth)
- Try refreshing client connection

### Media Upload Fails
- Check file size limits
- Verify you're authenticated as owner
- Ensure Blossom server is enabled

### WoT Not Working
- Wait for initial WoT fetch to complete (check logs)
- Verify your follow list is public
- Try lowering WoT depth

## Support

For issues and questions:
- GitHub: https://github.com/bitvora/haven/issues
- Nostr: Contact @bitvora

## Security Best Practices

1. **Keep Your nsec Private**: Never share your private key
2. **Use Tor Only**: Haven is designed for Tor-only operation
3. **Regular Backups**: Enable cloud backups or use Start9's backup feature
4. **Monitor Logs**: Check Haven logs periodically for anomalies
5. **Update Regularly**: Keep Haven updated to latest version

---

**Enjoy your sovereign Nostr infrastructure!** ğŸš€
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] instructions.md ä½œæˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¿½åŠ  (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

---

## ğŸ”’ Phase 2: Tor çµ±åˆ (Week 2)

### 2.1 Tor Hidden Service è¨­å®š

**ç›®çš„**: Clearnet ã‚’ç„¡åŠ¹åŒ–ã—ã€Tor ã®ã¿ã§å‹•ä½œ

#### Tor è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (`torrc`)

```
# Haven Tor Configuration
HiddenServiceDir /var/lib/tor/haven/
HiddenServicePort 80 127.0.0.1:3355

# Security hardening
SocksPort 0
ControlPort 0
CookieAuthentication 0

# Performance tuning
NumEntryGuards 8
```

#### Dockerfile ã¸ã® Tor çµ±åˆ

```dockerfile
# Install and configure Tor
RUN apk add --no-cache tor && \
    mkdir -p /var/lib/tor/haven && \
    chown -R tor:tor /var/lib/tor

# Copy Tor configuration
COPY torrc /etc/tor/torrc
```

#### entrypoint ã¸ã® Tor èµ·å‹•è¿½åŠ 

```bash
# Start Tor in background
log_info "Starting Tor Hidden Service..."
tor -f /etc/tor/torrc &
TOR_PID=$!

# Wait for Tor to generate .onion address
while [ ! -f /var/lib/tor/haven/hostname ]; do
    log_info "Waiting for Tor to generate .onion address..."
    sleep 2
done

TOR_ADDRESS=$(cat /var/lib/tor/haven/hostname)
log_info "Tor Hidden Service available at: ${TOR_ADDRESS}"
export TOR_ADDRESS
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] Tor è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] Dockerfile ã« Tor çµ±åˆ
- [ ] .onion ã‚¢ãƒ‰ãƒ¬ã‚¹è‡ªå‹•å–å¾—å®Ÿè£…
- [ ] Clearnet ç„¡åŠ¹åŒ–ç¢ºèª

---

### 2.2 Haven ã‚³ãƒ¼ãƒ‰ã® Tor å¯¾å¿œä¿®æ­£

**ç›®çš„**: HTTPS å‚ç…§ã‚’ Tor ã«å¯¾å¿œã•ã›ã‚‹

#### config.go ä¿®æ­£æ¡ˆ

```go
// RelayURL ã‚’ .onion ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾å¿œ
func loadConfig() Config {
    relayURL := getEnv("RELAY_URL")
    
    // Tor ã®å ´åˆã¯ ws:// ã‚’ä½¿ç”¨ã€https:// ã¯ä½¿ã‚ãªã„
    var serviceURL string
    if strings.HasSuffix(relayURL, ".onion") {
        serviceURL = "ws://" + relayURL
    } else {
        serviceURL = "wss://" + relayURL
    }
    
    return Config{
        // ... existing fields
        RelayURL: relayURL,
        ServiceURL: serviceURL,
    }
}
```

#### init.go ä¿®æ­£æ¡ˆ

```go
// ServiceURL ã‚’ Tor å¯¾å¿œã«
privateRelay.ServiceURL = config.ServiceURL + "/private"
chatRelay.ServiceURL = config.ServiceURL + "/chat"
outboxRelay.ServiceURL = config.ServiceURL
inboxRelay.ServiceURL = config.ServiceURL + "/inbox"

// Blossom ã‚‚ Tor å¯¾å¿œ
bl := blossom.New(outboxRelay, config.ServiceURL)
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] config.go ã« Tor åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [ ] init.go ã® ServiceURL è¨­å®šã‚’ä¿®æ­£
- [ ] HTTPS/WSS å‚ç…§ã‚’å‹•çš„ã«å¤‰æ›´
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã® URL è¡¨ç¤ºä¿®æ­£

---

## ğŸ“ Phase 3: Blossom Server æœ€é©åŒ– (Week 2-3)

### 3.1 NIP-96 å®Œå…¨æº–æ‹ ç¢ºèª

**ç›®çš„**: Amethyst ã§ã®åˆ©ç”¨ã‚’ä¿è¨¼

#### å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | ç›®çš„ |
|------------|--------|------|
| `/upload` | POST | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `/<sha256>` | GET | ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— |
| `/list` | GET | ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ |
| `/delete` | DELETE | ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ |

#### ç¾åœ¨ã®å®Ÿè£…ç¢ºèª

```go
// khatru/blossom ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ—¢ã«å®Ÿè£…æ¸ˆã¿
bl := blossom.New(outboxRelay, config.ServiceURL)
bl.Store = blossom.EventStoreBlobIndexWrapper{...}
bl.StoreBlob = [...] // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
bl.LoadBlob = [...] // ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
bl.DeleteBlob = [...] // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
```

**ç¢ºèªé …ç›®**:
- [ ] NIP-96 ã®å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…ç¢ºèª
- [ ] BUD-02 ä»•æ§˜æº–æ‹ ç¢ºèª
- [ ] Amethyst ã§ã®å‹•ä½œãƒ†ã‚¹ãƒˆ
- [ ] MIME type åˆ¤å®šã®æ­£ç¢ºæ€§ç¢ºèª

---

### 3.2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–

**ç›®çš„**: Blossom ãƒ•ã‚¡ã‚¤ãƒ«ã®åŠ¹ç‡çš„ãªç®¡ç†

#### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ 

```
/data/blossom/
â”œâ”€â”€ <sha256_1>    (ãƒ•ã‚¡ã‚¤ãƒ«å = SHA256 ãƒãƒƒã‚·ãƒ¥)
â”œâ”€â”€ <sha256_2>
â””â”€â”€ <sha256_n>
```

#### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

```yaml
# manifest.yaml ã«è¿½åŠ 
config:
  blossom_storage_limit:
    type: number
    name: Blossom Storage Limit (GB)
    description: Maximum storage for media files
    nullable: false
    default: 10
    range: [1, 1000]
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…
- [ ] ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™æ©Ÿèƒ½è¿½åŠ  (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- [ ] å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•å‰Šé™¤æ©Ÿèƒ½ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- [ ] ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º

---

### 3.3 ãƒ¡ãƒ‡ã‚£ã‚¢æ¤œè¨¼å¼·åŒ–

**ç›®çš„**: æ‚ªæ„ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é˜²æ­¢

```go
// bl.RejectUpload ã«æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
bl.RejectUpload = append(bl.RejectUpload, func(ctx context.Context, event *nostr.Event, size int, ext string) (bool, string, int) {
    // Owner æ¤œè¨¼
    if event.PubKey != nPubToPubkey(config.OwnerNpub) {
        return true, "only the owner can upload", 403
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ (ä¾‹: 100MB)
    maxSize := 100 * 1024 * 1024
    if size > maxSize {
        return true, "file too large", 413
    }
    
    // è¨±å¯ã™ã‚‹ MIME types
    allowedTypes := map[string]bool{
        "image/jpeg": true,
        "image/png": true,
        "image/gif": true,
        "image/webp": true,
        "video/mp4": true,
        "video/webm": true,
    }
    
    if !allowedTypes[ext] {
        return true, "file type not allowed", 415
    }
    
    return false, ext, size
})
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™å®Ÿè£…
- [ ] MIME type ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆå®Ÿè£…
- [ ] SHA256 æ¤œè¨¼å®Ÿè£…
- [ ] ãƒãƒ«ã‚¦ã‚§ã‚¢ã‚¹ã‚­ãƒ£ãƒ³çµ±åˆ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

---

## ğŸ¨ Phase 4: UI/UX æ”¹å–„ (Week 3)

### 4.1 Start9 Config UI å®Ÿè£…

**ç›®çš„**: Web UI ã§ã®ç›´æ„Ÿçš„ãªè¨­å®šå¤‰æ›´

#### Config Get Script (`assets/compat/config_get.sh`)

```bash
#!/bin/bash

set -e

# Generate current config as YAML
cat <<EOF
owner-npub:
  type: string
  name: Owner Nostr Public Key
  description: Your npub (nostr public key)
  nullable: false
  masked: false
  copyable: true

db-engine:
  type: enum
  name: Database Engine
  description: Choose database backend
  values:
    - badger
    - lmdb
  default: badger

private-relay-name:
  type: string
  name: Private Relay Name
  description: Display name for your private relay
  nullable: false
  default: "Haven Private"

chat-wot-depth:
  type: number
  name: Web of Trust Depth
  description: How many hops in follow graph
  nullable: false
  default: 2
  range: [1, 3]

backup-enabled:
  type: boolean
  name: Enable Cloud Backups
  description: Automatically backup to cloud storage
  default: false

backup-provider:
  type: enum
  name: Backup Provider
  description: Choose backup service
  values:
    - none
    - s3
  default: none
  depends-on:
    backup-enabled: true
EOF
```

#### Config Set Script (`assets/compat/config_set.sh`)

```bash
#!/bin/bash

set -e

# Read new config from stdin
CONFIG=$(cat)

# Parse YAML and set environment variables
# (This would use yq or similar tool)

# Validate configuration
if [ -z "$(echo "$CONFIG" | yq '.owner-npub')" ]; then
    echo "Error: owner-npub is required" >&2
    exit 1
fi

# Write to persistent storage
echo "$CONFIG" > /data/config.yaml

# Restart service to apply changes
restart-service
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] config_get.sh ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] config_set.sh ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] è¨­å®šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] UI ã§ã®è¨­å®šå¤‰æ›´ãƒ†ã‚¹ãƒˆ

---

### 4.2 Properties Display å®Ÿè£…

**ç›®çš„**: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º

#### Properties Script (`assets/compat/properties.sh`)

```bash
#!/bin/bash

set -e

# Get Tor address
TOR_ADDRESS=$(cat /var/lib/tor/haven/hostname 2>/dev/null || echo "Generating...")

# Get database stats
DB_SIZE=$(du -sh /data/db | cut -f1)
BLOSSOM_SIZE=$(du -sh /data/blossom | cut -f1)
BLOSSOM_FILES=$(find /data/blossom -type f | wc -l)

# Get service status
SERVICE_STATUS="Running"

# Output as YAML
cat <<EOF
version: 2
data:
  Tor Address:
    type: string
    value: "${TOR_ADDRESS}"
    description: Your .onion address
    copyable: true
    qr: true
  
  Outbox Relay:
    type: string
    value: "ws://${TOR_ADDRESS}"
    description: Public relay URL
    copyable: true
  
  Private Relay:
    type: string
    value: "ws://${TOR_ADDRESS}/private"
    description: Private relay URL
    copyable: true
  
  Chat Relay:
    type: string
    value: "ws://${TOR_ADDRESS}/chat"
    description: Chat relay URL
    copyable: true
  
  Inbox Relay:
    type: string
    value: "ws://${TOR_ADDRESS}/inbox"
    description: Inbox relay URL
    copyable: true
  
  Blossom Server:
    type: string
    value: "http://${TOR_ADDRESS}"
    description: Media server URL
    copyable: true
  
  Database Size:
    type: string
    value: "${DB_SIZE}"
    description: Total database storage used
  
  Media Files:
    type: string
    value: "${BLOSSOM_FILES} files (${BLOSSOM_SIZE})"
    description: Blossom media storage
  
  Status:
    type: string
    value: "${SERVICE_STATUS}"
    description: Service health status
EOF
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] properties.sh ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] QR ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºå®Ÿè£…
- [ ] ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†å®Ÿè£…
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ç¢ºèª

---

### 4.3 Health Check å®Ÿè£…

**ç›®çš„**: ã‚µãƒ¼ãƒ“ã‚¹æ­£å¸¸æ€§ã®è‡ªå‹•ç¢ºèª

#### Health Check Script (`assets/compat/check-web.sh`)

```bash
#!/bin/bash

set -e

# Check if Haven is responding
if curl -sf -o /dev/null http://localhost:3355 > /dev/null 2>&1; then
    echo '{"status":"success","message":"Haven is running"}'
    exit 0
else
    echo '{"status":"error","message":"Haven is not responding"}'
    exit 1
fi
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] WebSocket æ¥ç¶šãƒ†ã‚¹ãƒˆè¿½åŠ 
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªè¿½åŠ 
- [ ] Tor ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèªè¿½åŠ 

---

## ğŸš€ Phase 5: ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ (Week 4)

### 5.1 Makefile ä½œæˆ

**ç›®çš„**: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®è‡ªå‹•åŒ–

```makefile
PACKAGE_ID := haven
VERSION := $(shell cat manifest.yaml | yq '.version')
ARCHITECTURES := amd64 arm64

.PHONY: all
all: verify

.PHONY: verify
verify: $(PACKAGE_ID).s9pk
	start-sdk verify s9pk $(PACKAGE_ID).s9pk

$(PACKAGE_ID).s9pk: manifest.yaml docker-images.tar icon.png instructions.md LICENSE scripts/
	start-sdk pack

docker-images.tar: Dockerfile docker_entrypoint.sh prepare.sh
	./prepare.sh
	DOCKER_CLI_EXPERIMENTAL=enabled docker buildx build \
		--platform linux/$(ARCHITECTURES) \
		--tag start9/$(PACKAGE_ID)/main:$(VERSION) \
		--output type=docker,dest=docker-images.tar \
		.

.PHONY: clean
clean:
	rm -f $(PACKAGE_ID).s9pk
	rm -f docker-images.tar

.PHONY: test
test:
	@echo "Running tests..."
	go test ./...

.PHONY: install
install: $(PACKAGE_ID).s9pk
	start-cli package install $(PACKAGE_ID).s9pk
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] Makefile ä½œæˆ
- [ ] ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (ä¸¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [ ] ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ç¢ºèª
- [ ] CI/CD çµ±åˆæº–å‚™

---

### 5.2 prepare.sh ä½œæˆ

**ç›®çš„**: ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã®æº–å‚™

```bash
#!/bin/bash

set -e

echo "Preparing build environment..."

# Install Start9 SDK if not present
if ! command -v start-sdk &> /dev/null; then
    echo "Installing Start9 SDK..."
    curl -sSL https://get.start9.com/sdk | bash
fi

# Install Docker buildx
docker buildx version || docker buildx create --use

# Enable multi-arch builds
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

# Install yq for YAML processing
if ! command -v yq &> /dev/null; then
    echo "Installing yq..."
    sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
    sudo chmod +x /usr/local/bin/yq
fi

echo "Build environment ready!"
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] prepare.sh ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¯ãƒªãƒ¼ãƒ³ç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ç¢ºèª

---

### 5.3 ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

#### 5.3.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```bash
# Go tests
go test -v ./...

# Config validation tests
./scripts/test-config.sh

# Docker build test
docker build -t haven-test .
```

#### 5.3.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# Install on Start9 test instance
start-cli package install haven.s9pk

# Verify all relays are accessible
./scripts/test-relays.sh <tor-address>

# Test Blossom upload/download
./scripts/test-blossom.sh <tor-address>
```

#### 5.3.3 Amethyst é€£æºãƒ†ã‚¹ãƒˆ

```markdown
1. Install Haven on Start9
2. Get .onion address
3. Open Amethyst
4. Add Haven relay URLs
5. Test posting
6. Test media upload
7. Verify media displays correctly
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ 80% ä»¥ä¸Šé”æˆ
- [ ] Amethyst ã§ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ

---

## ğŸ“¤ Phase 6: å…¬é–‹ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ (Week 5)

### 6.1 ã‚¢ã‚¤ã‚³ãƒ³ä½œæˆ

**è¦ä»¶**:
- ã‚µã‚¤ã‚º: 256x256px (æ¨å¥¨)
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: PNG (é€éèƒŒæ™¯æ¨å¥¨)
- ãƒ‡ã‚¶ã‚¤ãƒ³: Haven ã®ãƒ­ã‚´ã¾ãŸã¯ã‚·ãƒ³ãƒœãƒ«

**ã‚¿ã‚¹ã‚¯**:
- [ ] icon.png ä½œæˆ (256x256px)
- [ ] è¤‡æ•°ã‚µã‚¤ã‚ºæº–å‚™ (64px, 128px, 512px)
- [ ] Start9 UI ã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª

---

### 6.2 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

#### README.md æ›´æ–°

```markdown
# Haven for Start9

Self-sovereign Nostr relay suite with Blossom media server, designed for Start9 Server.

## Features

- ğŸ”’ Four specialized Nostr relays (Private, Chat, Inbox, Outbox)
- ğŸ“ Integrated Blossom media server (NIP-96 & BUD-02 compliant)
- ğŸ§… Tor-only operation for maximum privacy
- ğŸ•¸ï¸ Web of Trust protection against spam
- â˜ï¸ Optional cloud backups
- ğŸ“¦ Easy installation on Start9

## Installation

1. Download `haven.s9pk` from [Releases](releases)
2. In Start9 UI: System â†’ Sideload Service
3. Upload `haven.s9pk`
4. Follow setup instructions

## Documentation

- [Setup Guide](docs/setup.md)
- [Configuration](docs/configuration.md)
- [Troubleshooting](docs/troubleshooting.md)
- [API Reference](docs/api.md)

## Support

- GitHub Issues: [bitvora/haven/issues](https://github.com/bitvora/haven/issues)
- Nostr: @bitvora

## License

MIT License - see [LICENSE](LICENSE)
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] README.md æ›´æ–°
- [ ] CHANGELOG.md ä½œæˆ
- [ ] API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
- [ ] ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ä½œæˆ

---

### 6.3 Start9 ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¬ã‚¸ã‚¹ãƒˆãƒªç”³è«‹

#### ç”³è«‹è¦ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `manifest.yaml` å®Œæˆ
- [ ] `instructions.md` å®Œæˆ
- [ ] `LICENSE` ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨
- [ ] `icon.png` é©åˆ‡ãªã‚µã‚¤ã‚º
- [ ] ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹è‡ªå‹•åŒ–
- [ ] ãƒ†ã‚¹ãƒˆé€šé
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

#### ç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹

1. Fork [start9labs/registry](https://github.com/start9labs/registry)
2. `packages/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Haven è¿½åŠ 
3. Pull Request ä½œæˆ
4. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œ
5. ãƒãƒ¼ã‚¸å¾Œã€å…¬å¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«æ²è¼‰

**ã‚¿ã‚¹ã‚¯**:
- [ ] Registry fork ä½œæˆ
- [ ] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
- [ ] PR ä½œæˆ
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œ

---

### 6.4 ç¶™ç¶šçš„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨ˆç”»

#### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

```
Major.Minor.Patch
  |     |     |
  |     |     â””â”€ Bug fixes, security patches
  |     â””â”€â”€â”€â”€â”€â”€â”€ New features, improvements
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Breaking changes
```

#### ãƒªãƒªãƒ¼ã‚¹ã‚µã‚¤ã‚¯ãƒ«

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒ**: å³æ™‚ãƒªãƒªãƒ¼ã‚¹
- **ãƒã‚°ä¿®æ­£**: 2é€±é–“ã”ã¨
- **æ–°æ©Ÿèƒ½**: 1ãƒ¶æœˆã”ã¨
- **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 6ãƒ¶æœˆã”ã¨

#### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæˆ¦ç•¥

```yaml
# manifest.yaml - Migration example
migrations:
  from:
    "1.0.0":
      type: script
      args: ["migrate-from-1.0.0"]
  to:
    "2.0.0":
      type: script
      args: ["migrate-to-2.0.0"]
```

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°è¦å‰‡æ–‡æ›¸åŒ–
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™
- [ ] ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ‰‹é †æ–‡æ›¸åŒ–
- [ ] CI/CD è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹è¨­å®š

---

## ğŸ¯ æˆåŠŸåŸºæº– (Definition of Done)

### Phase 1-2: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°åŸºç¤
- [ ] Dockerfile ãŒ amd64/arm64 ä¸¡æ–¹ã§ãƒ“ãƒ«ãƒ‰æˆåŠŸ
- [ ] manifest.yaml ãŒ `start-sdk verify` ã‚’é€šé
- [ ] Tor Hidden Service ãŒæ­£å¸¸ã«èµ·å‹•ã— .onion ã‚¢ãƒ‰ãƒ¬ã‚¹ç”Ÿæˆ
- [ ] 4ã¤ã® Nostr ãƒªãƒ¬ãƒ¼ã™ã¹ã¦ãŒ Tor çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### Phase 3: Blossom çµ±åˆ
- [ ] Blossom ã‚µãƒ¼ãƒãƒ¼ãŒ NIP-96 ã«å®Œå…¨æº–æ‹ 
- [ ] Amethyst ã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
- [ ] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] SHA256 ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼ãŒæ­£å¸¸å‹•ä½œ

### Phase 4-5: UI/ãƒ†ã‚¹ãƒˆ
- [ ] Start9 UI ã§è¨­å®šå¤‰æ›´å¯èƒ½
- [ ] Properties ã« .onion ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨çµ±è¨ˆæƒ…å ±è¡¨ç¤º
- [ ] Health Check ãŒæ­£å¸¸å‹•ä½œ
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ 80% ä»¥ä¸Š

### Phase 6: å…¬é–‹
- [ ] Community Registry ã«æ²è¼‰ç”³è«‹æ¸ˆã¿
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™
- [ ] GitHub Releases ã§é…å¸ƒé–‹å§‹
- [ ] 5äººä»¥ä¸Šã®ãƒ™ãƒ¼ã‚¿ãƒ†ã‚¹ã‚¿ãƒ¼ç¢ºä¿

---

## ğŸ“Š ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

### é«˜ãƒªã‚¹ã‚¯é …ç›®

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|-------|--------|------|
| Tor æ¥ç¶šä¸å®‰å®š | é«˜ | ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã€æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆèª¿æ•´ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è‚¥å¤§åŒ– | ä¸­ | å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç›£è¦– |
| Blossom ä»•æ§˜å¤‰æ›´ | ä¸­ | khatru ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®šæœŸæ›´æ–° |
| Start9 API å¤‰æ›´ | ä¸­ | SDK ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™ |

### æŠ€è¡“çš„èª²é¡Œ

1. **Tor ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: WebSocket æ¥ç¶šã®æœ€é©åŒ–
2. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ¶ç´„**: åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿ç®¡ç†
3. **èªè¨¼ãƒ•ãƒ­ãƒ¼**: NIP-42 Auth ã®ç¢ºå®Ÿãªå®Ÿè£…
4. **WoT æ›´æ–°**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®è»½é‡åŒ–

---

## ğŸ—“ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ¦‚è¦

```
Week 1: åŸºç¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
â”œâ”€ Day 1-2: Dockerfile, entrypoint ä½œæˆ
â”œâ”€ Day 3-4: manifest.yaml, instructions.md ä½œæˆ
â””â”€ Day 5-7: åˆå›ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ

Week 2: Tor çµ±åˆ
â”œâ”€ Day 1-2: Tor Hidden Service è¨­å®š
â”œâ”€ Day 3-4: Haven ã‚³ãƒ¼ãƒ‰ä¿®æ­£ (Tor å¯¾å¿œ)
â””â”€ Day 5-7: Tor çµŒç”±æ¥ç¶šãƒ†ã‚¹ãƒˆ

Week 3: Blossom æœ€é©åŒ– & UI
â”œâ”€ Day 1-3: Blossom ã‚µãƒ¼ãƒãƒ¼æ¤œè¨¼ãƒ»æœ€é©åŒ–
â”œâ”€ Day 4-5: Config/Properties UI å®Ÿè£…
â””â”€ Day 6-7: Health Check å®Ÿè£…

Week 4: ãƒ†ã‚¹ãƒˆ & ä¿®æ­£
â”œâ”€ Day 1-2: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
â”œâ”€ Day 3-4: Amethyst å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ
â””â”€ Day 5-7: ãƒã‚°ä¿®æ­£ãƒ»æœ€é©åŒ–

Week 5: å…¬é–‹æº–å‚™
â”œâ”€ Day 1-2: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
â”œâ”€ Day 3-4: Registry ç”³è«‹æº–å‚™
â””â”€ Day 5-7: ãƒ™ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œ
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

### Start9 é–¢é€£
- [Service Packaging Documentation](https://docs.start9.com/0.3.5.x/developer-docs/packaging.html)
- [Start SDK Repository](https://github.com/Start9Labs/start-os)
- [Community Registry](https://github.com/start9labs/registry)

### Nostr é–¢é€£
- [NIP-01: Basic protocol flow](https://github.com/nostr-protocol/nips/blob/master/01.md)
- [NIP-42: Authentication](https://github.com/nostr-protocol/nips/blob/master/42.md)
- [NIP-96: HTTP File Storage Integration](https://github.com/nostr-protocol/nips/blob/master/96.md)
- [BUD-02: Blossom Spec](https://github.com/hzrd149/blossom)

### Blossom é–¢é€£
- [Blossom Server Spec](https://github.com/hzrd149/blossom)
- [khatru/blossom Package](https://pkg.go.dev/github.com/fiatjaf/khatru/blossom)

### Tor é–¢é€£
- [Tor Hidden Service Setup](https://community.torproject.org/onion-services/setup/)
- [Tor Best Practices](https://community.torproject.org/onion-services/advanced/)

---

## âœ… æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **å³åº§ã«é–‹å§‹**:
   - [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ æ•´ç†
   - [ ] Dockerfile ä½œæˆé–‹å§‹
   - [ ] docker_entrypoint.sh é››å½¢ä½œæˆ

2. **Week 1 ã®å„ªå…ˆã‚¿ã‚¹ã‚¯**:
   - [ ] manifest.yaml ä½œæˆ
   - [ ] instructions.md åˆç¨¿ä½œæˆ
   - [ ] åˆå›ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ

3. **æº–å‚™äº‹é …**:
   - [ ] Start9 Server ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
   - [ ] Amethyst ãƒ†ã‚¹ãƒˆç«¯æœ«æº–å‚™
   - [ ] Git ãƒªãƒã‚¸ãƒˆãƒªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

---

**ä½œæˆæ—¥**: 2025-12-24  
**æœ€çµ‚æ›´æ–°**: 2025-12-24  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Ready to Implement  
**æ‹…å½“**: Oracle + AI Assistant

---

_This is a living document. Update as implementation progresses._

