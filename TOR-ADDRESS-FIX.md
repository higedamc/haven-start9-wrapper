# ğŸ”§ Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸ä¸€è‡´å•é¡Œ - ä¿®æ­£å®Œäº†

## ğŸ“‹ å•é¡Œã®åŸå› 

Haven Start9 Wrapper ã§ **2ã¤ã®ç•°ãªã‚‹ Tor ã‚¢ãƒ‰ãƒ¬ã‚¹** ãŒå­˜åœ¨ã—ã¦ã„ã¾ã—ãŸï¼š

1. **Haven ãŒç®¡ç†** (æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹):
   - `/data/tor/haven/hostname` ã«ä¿å­˜
   - Haven ãŒ `torrc` ã‚’ä½¿ã£ã¦è‡ªåˆ†ã§ Tor ã‚’èµ·å‹•
   - ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ **æ°¸ç¶šåŒ–ã•ã‚Œã‚‹**

2. **Start9 ãŒè‡ªå‹•ç”Ÿæˆ** (èª¤ã£ãŸã‚¢ãƒ‰ãƒ¬ã‚¹):
   - `manifest.yaml` ã® `interfaces` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ `tor-config` ã‚’æŒ‡å®š
   - Start9 ãŒåˆ¥ã® Tor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•
   - Haven ã® Tor ã¨ **ç«¶åˆ** ã—ã¦ã„ãŸ

### ç—‡çŠ¶

- âœ… Properties: `/data/tor_address.txt` ã‹ã‚‰èª­ã‚“ã ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆHavenç®¡ç†ï¼‰
- âŒ Interfaces/LAUNCH UI: Start9 ãŒç”Ÿæˆã—ãŸåˆ¥ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
- âŒ Health Check: å¤±æ•—ï¼ˆç•°ãªã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ï¼‰

---

## âœ… å®Ÿæ–½ã—ãŸä¿®æ­£

### 1. Properties ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/procedures/properties.ts`

**å¤‰æ›´å†…å®¹**:
```typescript
// Before: é–“æ¥çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã‚€
torAddress = (await Deno.readTextFile("/data/tor_address.txt")).trim();

// After: Tor ã® hostname ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç›´æ¥èª­ã‚€ï¼ˆSOURCE OF TRUTHï¼‰
torAddress = (await Deno.readTextFile("/data/tor/haven/hostname")).trim();
```

**ç†ç”±**: `/data/tor/haven/hostname` ãŒ Tor ãŒç”Ÿæˆã™ã‚‹ **å”¯ä¸€ã®æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹**

---

### 2. manifest.yaml ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `manifest.yaml`

**å¤‰æ›´å†…å®¹**:
```yaml
# Before: Start9 ã« Tor ã‚’ç®¡ç†ã•ã›ã‚‹è¨­å®š
interfaces:
  main:
    tor-config:
      port-mapping:
        "3355": "80"
    ui: true

# After: Haven ãŒè‡ªåˆ†ã§ Tor ã‚’ç®¡ç†
interfaces:
  main:
    tor-config: null  # Start9 ã® Tor ã‚’ç„¡åŠ¹åŒ–
    ui: false         # LAUNCH UI ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
```

**ç†ç”±**: 
- Haven ã¯è‡ªåˆ†ã§ Tor ã‚’èµ·å‹•ã™ã‚‹ã®ã§ã€Start9 ã® Tor ã¯ä¸è¦
- 2ã¤ã® Tor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç«¶åˆã™ã‚‹ã®ã‚’é˜²ã

---

### 3. Properties ã« Web Interface URL ã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/procedures/properties.ts`

**è¿½åŠ å†…å®¹**:
```typescript
"Web Interface": {
  type: "string",
  value: `http://${torAddress}/`,
  description: "Haven Web Interface (Dashboard)",
  copyable: true,
  qr: false,
  masked: false,
},
```

**ç†ç”±**: 
- LAUNCH UI ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸã®ã§ã€Properties ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£ã—ã„ URL ã‚’ç°¡å˜ã«ã‚³ãƒ”ãƒ¼ã§ãã‚‹

---

### 4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/procedures/properties.ts`

**å¤‰æ›´å†…å®¹**:
```typescript
// Before
"Haven Version": { value: "1.0.6" }

// After
"Haven Version": { value: "1.1.6" }
```

---

## ğŸ¯ ä¿®æ­£å¾Œã®å‹•ä½œ

### Properties ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹

```
Haven Version: 1.1.6
Service Status: Running
Tor Hidden Service: <your-onion-address>.onion
Web Interface: http://<your-onion-address>.onion/  â† NEW!
Outbox Relay: ws://<your-onion-address>.onion
Private Relay: ws://<your-onion-address>.onion/private
Chat Relay: ws://<your-onion-address>.onion/chat
Inbox Relay: ws://<your-onion-address>.onion/inbox
Blossom Media Server: http://<your-onion-address>.onion
Database Size: ...
Media Storage: ...
Total Storage: ...
```

### ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•

1. **Properties** ç”»é¢ã‚’é–‹ã
2. **Web Interface** ã® URL ã‚’ã‚³ãƒ”ãƒ¼
3. Tor ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯ Start9 ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
4. Haven ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
5. **ğŸ“Š View Database Dashboard** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## âœ… æ—¢å­˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®å½±éŸ¿

### âœ… å®‰å…¨ã§ã™ï¼

> ä»Šä½¿ã£ã¦ã„ã‚‹ `/data/tor_address.txt` ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã‚‹ã“ã¨ã¯ãªã„ï¼Ÿ

**å›ç­”**: **å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼**

ç†ç”±ï¼š
1. `/data/tor/haven/hostname` ãŒ **SOURCE OF TRUTH**
2. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/data/tor/haven/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
3. `/data/` ã¯æ°¸ç¶šåŒ–ãƒœãƒªãƒ¥ãƒ¼ãƒ ãªã®ã§ã€å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ä¿æŒã•ã‚Œã‚‹
4. Tor ã®ç§˜å¯†éµã‚‚åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå†ç”Ÿæˆã•ã‚Œã‚‹

### ç¢ºèªæ–¹æ³•

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ç¢ºèª
docker exec <container-id> cat /data/tor/haven/hostname

# ä»¥å‰ã¨åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
```

---

## ğŸ”„ å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

### Step 1: ãƒ“ãƒ«ãƒ‰

```bash
cd /Users/apple/work/haven-start9-wrapper

# TypeScript ã‚’ãƒãƒ³ãƒ‰ãƒ«ï¼ˆã™ã§ã«å®Ÿè¡Œæ¸ˆã¿ï¼‰
deno run --allow-read --allow-write --allow-env --allow-net scripts/bundle.ts

# ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
make clean
make
```

### Step 2: Haven ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. Start9 UI â†’ Services â†’ Haven
2. **Uninstall** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### Step 3: æ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. **System** â†’ **Sideload Service**
2. `haven.s9pk` ã‚’é¸æŠ
3. **Install**

### Step 4: è¨­å®š

1. **Owner Npub** ã‚’è¨­å®šï¼ˆä»¥å‰ã¨åŒã˜å€¤ï¼‰
2. ãã®ä»–ã®è¨­å®šã‚‚å…¥åŠ›
3. **Save**

### Step 5: èµ·å‹•

1. **START** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. èµ·å‹•å®Œäº†ã‚’å¾…ã¤

### Step 6: Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª

1. **Properties** ã‚’é–‹ã
2. **Tor Hidden Service** ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª
3. **ä»¥å‰ã¨åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹** ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª âœ…

### Step 7: Web Interface ã«ã‚¢ã‚¯ã‚»ã‚¹

1. **Properties** â†’ **Web Interface** ã® URL ã‚’ã‚³ãƒ”ãƒ¼
2. Tor ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
3. Dashboard ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹çµæœ

### âœ… æˆåŠŸã®ã‚µã‚¤ãƒ³

- [ ] Properties ã«æ­£ã—ã„ Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ä»¥å‰ã¨ **åŒã˜ .onion ã‚¢ãƒ‰ãƒ¬ã‚¹**
- [ ] **Health Check** ãŒç·‘è‰²ï¼ˆâœ“ï¼‰ã«ãªã‚‹
- [ ] **Web Interface** URL ã‹ã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [ ] `/dashboard` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ Database Dashboard ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] Kind ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ï¼‰

### âŒ å¤±æ•—ã®ã‚µã‚¤ãƒ³

- Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸ â†’ `/data/tor/haven/` ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§
- Health Check ãŒå¤±æ•— â†’ Haven ãŒèµ·å‹•ã—ã¦ã„ãªã„ã€ã¾ãŸã¯ãƒ­ã‚°ã‚’ç¢ºèª
- Dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ â†’ Haven submodule ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ãªã„

---

## ğŸ“Š ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒãƒ¼ãƒˆ

### ãªãœ2ã¤ã® Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå­˜åœ¨ã—ãŸã®ã‹ï¼Ÿ

Start9 ã®è¨­è¨ˆã§ã¯ï¼š
- `manifest.yaml` ã§ `tor-config` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€Start9 ãŒ Tor ã‚’ç®¡ç†ã™ã‚‹
- Haven ã¯ç‹¬è‡ªã« Tor ã‚’èµ·å‹•ã—ã¦ã„ãŸï¼ˆ`docker_entrypoint.sh` + `torrc`ï¼‰
- çµæœï¼š2ã¤ã® Tor ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåŒæ™‚ã«å‹•ä½œã—ã€ãã‚Œãã‚Œç•°ãªã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç”Ÿæˆ

### æ­£ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Start9 Server                       â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Haven Container              â”‚  â”‚
â”‚  â”‚                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Haven    â”‚  â”‚ Tor      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (3355)   â”‚â†â†’â”‚ (80)     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                 â†“            â”‚  â”‚
â”‚  â”‚           /data/tor/haven/   â”‚  â”‚
â”‚  â”‚           hostname          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  Properties reads from:             â”‚
â”‚  /data/tor/haven/hostname          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
/data/
â”œâ”€â”€ tor/
â”‚   â””â”€â”€ haven/
â”‚       â”œâ”€â”€ hostname        â† SOURCE OF TRUTH
â”‚       â”œâ”€â”€ hs_ed25519_public_key
â”‚       â””â”€â”€ hs_ed25519_secret_key
â”œâ”€â”€ tor_address.txt         â† å»ƒæ­¢äºˆå®šï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ private/
â”‚   â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ outbox/
â”‚   â””â”€â”€ inbox/
â””â”€â”€ blossom/
```

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã£ãŸå ´åˆ

**åŸå› **: `/data/tor/haven/` ãŒå‰Šé™¤ã•ã‚ŒãŸ

**å¯¾å‡¦æ³•**:
1. æ®‹å¿µãªãŒã‚‰ã€Tor ã®ç§˜å¯†éµãŒå¤±ã‚ã‚ŒãŸã®ã§ **ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¾©å…ƒã§ãã¾ã›ã‚“**
2. æ–°ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ Nostr ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¨­å®šã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™
3. ä»Šå¾Œã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨ï¼š
   ```bash
   # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   docker exec <container> tar -czf /tmp/tor-backup.tar.gz /data/tor/haven
   docker cp <container>:/tmp/tor-backup.tar.gz ./tor-backup.tar.gz
   ```

### Health Check ãŒå¤±æ•—ã™ã‚‹å ´åˆ

1. Haven ã®ãƒ­ã‚°ã‚’ç¢ºèªï¼š
   ```
   Services â†’ Haven â†’ Logs
   ```

2. ä»¥ä¸‹ã‚’ç¢ºèªï¼š
   - `ğŸ”— listening at 0.0.0.0:3355` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„ã‹

3. ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ç¢ºèªï¼š
   ```bash
   docker exec <container> curl -sf http://localhost:3355
   # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã¯ãš
   ```

### Web Interface ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆ

1. Tor ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ç¢ºèª
2. URL ãŒ `http://` ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆ`https://` ã§ã¯ãªã„ï¼‰
3. ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æœ«å°¾ã« `.onion` ãŒã‚ã‚‹ã‹ç¢ºèª

---

## ğŸ“ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

1. **LAUNCH UI ãƒœã‚¿ãƒ³ã®å¾©æ´»**
   - Start9 ã®ä»•æ§˜ã‚’ç¢ºèªã—ã¦ã€Haven ãŒç®¡ç†ã—ã¦ã„ã‚‹ Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ LAUNCH UI ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

2. **è‡ªå‹•ãƒ†ã‚¹ãƒˆ**
   - Health Check ã§ `/dashboard` ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œç¢ºèª

3. **Tor ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½**
   - Haven ã® Action ã¨ã—ã¦ Tor ç§˜å¯†éµã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¿½åŠ 

---

**ä½œæˆæ—¥**: 2025-12-27  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… ä¿®æ­£å®Œäº†ã€ãƒ†ã‚¹ãƒˆå¾…ã¡  
**å½±éŸ¿**: æ—¢å­˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¿æŒã•ã‚Œã‚‹ï¼ˆå®‰å…¨ï¼‰

