# ==============================================================================
# Haven Start9 Package Manifest
# ==============================================================================

id: haven
title: Haven
version: 1.1.4
ui: false
release-notes: |
  **v1.1.4 - Blastr Timeout Optimization (2025-12-25)**
  
  Improvements:
  - **Extended Blastr Timeout**: Increased connection timeout from 5s to 15s
  - Better reliability for Tor-based relay connections
  - Reduced timeout errors for slow or distant relays
  - Improved IPv6-only relay connectivity
  
  **v1.1.3 - IPv6 Support for Blastr (2025-12-25)**
  
  New Features:
  - **IPv6 Support**: Blastr can now broadcast to IPv6-only relays
  - Tor configured to use IPv6 for outbound connections
  - Go's default HTTP client provides IPv6 support via Happy Eyeballs v2
  - IPv6 connectivity check on startup
  
  Technical Improvements:
  - Added ClientUseIPv6, ClientPreferIPv6ORPort, and IPv6Exit to torrc
  - IPv6 automatically preferred with 300ms fallback to IPv4 (RFC 8305)
  - Added iputils and iproute2 packages for IPv6 diagnostics
  - Startup logs now show IPv6 availability status
  
  **v1.1.2 - Blastr Debug Logging (2025-12-25)**
  
  Debug Improvements:
  - Added extensive debug logging for Blastr relay configuration
  - Shows config file reading process step-by-step
  - Displays yq and jq exit codes and outputs
  - Helps identify configuration issues
  
  **v1.1.1 - Critical Blastr Hotfix (2025-12-25)**
  
  CRITICAL Bug Fixes:
  - **BREAKING FIX**: Fixed Blastr relay list parsing that caused Haven to fail on startup
  - Simplified relay list initialization to use more reliable jq-based parsing
  - Added proper error handling and fallback to empty relay list
  - Fixed Properties display to show Blastr relay count
  - Improved logging for Blastr configuration
  
  **v1.1.0 - Blastr Relay Feature (2025-12-26)**
  
  New Features:
  - **Blastr Relay Broadcasting**: Events posted to Haven are now automatically forwarded to external relays
  - Configure Blastr relay list from Start9 UI (comma-separated relay URLs)
  - Default relay list includes popular Nostr relays (relay.damus.io, nos.lol, relay.nostr.band, etc.)
  - Support for both domain-only format (relay.damus.io) and full WebSocket URLs (wss://relay.damus.io)
  
  Improvements:
  - Added relay URL validation in configuration
  - Enhanced logging for Blastr relay operations
  - Relay count now displayed in logs (e.g., "blasted ... to 8 relays")
  
  **v1.0.8 - Critical Tor Address Persistence Fix (2025-12-25)**
  
  CRITICAL Bug Fixes:
  - **BREAKING FIX**: Tor Hidden Service directory now persists to /data/tor/haven/ (prevents .onion address from changing on updates)
  - This fix ensures your .onion address remains the same across package updates and restarts
  - Note: If you already updated to 1.0.7, your .onion address will change one more time with this update, but will then remain stable
  
  **v1.0.7 - Blossom Server Hotfix (2025-12-25)**
  
  Bug Fixes:
  - Fixed Blossom file storage path issue (media files now correctly saved to /data/blossom/)
  - Changed all relay ServiceURLs from https:// to http:// for proper Tor .onion address compatibility
  - Added detailed error logging for Blossom file operations (create, read, delete)
  - Fixed BlossomPath configuration to prevent trailing slash issues
  
  Improvements:
  - Enhanced Blossom server initialization logging for easier debugging
  - Improved error messages for media upload/download operations
  
  **v1.0.6 - Initial Release**
  - Initial Start9 release
  - Tor-only operation for maximum privacy
  - Full Blossom server support (NIP-96 & BUD-02 compliant)
  - Web of Trust integration for spam protection
  - Four specialized Nostr relays (Private, Chat, Inbox, Outbox)
  - BadgerDB and LMDB database engine support
license: MIT
wrapper-repo: https://github.com/bitvora/haven-start9-wrapper
upstream-repo: https://github.com/bitvora/haven
support-site: https://github.com/bitvora/haven/issues
marketing-site: https://github.com/bitvora/haven
donation-url: null

# ==============================================================================
# Package Description
# ==============================================================================

description:
  short: Self-sovereign Nostr relay suite with Blossom media server
  long: |
    Haven (High Availability Vault for Events on Nostr) is a comprehensive 
    personal Nostr relay implementation featuring four specialized relays 
    and an integrated Blossom media server. Run your own sovereign 
    communications infrastructure over Tor.
    
    **Features:**
    - **Private Relay**: Your personal secure storage for drafts and private notes
    - **Chat Relay**: Web of Trust protected direct messages (NIP-04)
    - **Inbox Relay**: Receive tagged events from trusted sources
    - **Outbox Relay**: Public broadcast of your events
    - **Blossom Server**: Decentralized media hosting (NIP-96 & BUD-02 compliant)
    - **Web of Trust**: Automatic spam protection based on your social graph
    - **Tor-Only**: Maximum privacy with .onion addresses
    - **Multiple DB Engines**: Choose between BadgerDB or LMDB
    - **Cloud Backups**: Optional S3-compatible backup integration
    
    **Compatible Clients:**
    - Amethyst (Android) - Full support including Blossom
    - Damus (iOS)
    - Primal
    - Coracle
    - nostrudel
    - And any Nostr client supporting NIP-42 (Auth)

# ==============================================================================
# Package Assets
# ==============================================================================

assets:
  license: LICENSE
  icon: icon.png
  instructions: instructions.md
  docker-images: docker-images.tar

# ==============================================================================
# Main Container Configuration
# ==============================================================================

main:
  type: docker
  image: main
  entrypoint: docker_entrypoint.sh
  args: []
  mounts:
    main: /data
  gpu-acceleration: false
  shm-size-mb: null

# ==============================================================================
# Health Checks
# ==============================================================================

health-checks:
  main:
    name: Web Interface
    success-message: Haven is running and accessible
    type: docker
    image: main
    entrypoint: check-web.sh
    args: []
    io-format: json
    inject: false
    mounts:
      main: /data

# ==============================================================================
# Configuration Management
# ==============================================================================

config:
  get:
    type: script
  set:
    type: script

# ==============================================================================
# Properties Display
# ==============================================================================

properties:
  type: docker
  image: main
  entrypoint: properties.sh
  args: []
  mounts:
    main: /data
  io-format: yaml
  inject: false

# ==============================================================================
# Volume Configuration
# ==============================================================================

volumes:
  main:
    type: data

# ==============================================================================
# Network Interfaces
# ==============================================================================

interfaces:
  main:
    name: Nostr Relay Interface
    description: Main Nostr relay endpoint (WebSocket) and Blossom media server
    tor-config:
      port-mapping:
        "3355": "80"
    lan-config: null
    ui: true
    protocols:
      - tcp
      - http
      - ws

# ==============================================================================
# Dependencies
# ==============================================================================

dependencies: {}

# ==============================================================================
# Backup Configuration
# ==============================================================================

backup:
  create:
    type: docker
    image: compat
    system: true
    entrypoint: compat
    args:
      - duplicity
      - create
      - /mnt/backup
      - /data
    mounts:
      BACKUP: /mnt/backup
      main: /data
  restore:
    type: docker
    image: compat
    system: true
    entrypoint: compat
    args:
      - duplicity
      - restore
      - /mnt/backup
      - /data
    mounts:
      BACKUP: /mnt/backup
      main: /data

# ==============================================================================
# Migrations
# ==============================================================================

migrations:
  from: {}
  to: {}

